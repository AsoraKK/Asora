---
import BaseLayout from '../../layouts/BaseLayout.astro';
const apiBase = import.meta.env.PUBLIC_API_BASE_URL ?? '';
---
<BaseLayout
  title="Invite"
  description="Redeem your Lythaus invite and open the app."
>
  <section class="invite-panel">
    <div
      class="status-panel"
      id="invite-status"
      data-api-base={apiBase}
      data-deeplink-base="asora://invite/"
    >
      <span class="pill">Invite check</span>
      <h1>You're almost in.</h1>
      <p id="invite-message">
        Validating your invite link.
      </p>
      <div class="status-actions">
        <a class="button primary" id="open-app" href="#">Open Lythaus</a>
        <button class="button secondary" id="copy-code" type="button">
          Copy invite code
        </button>
      </div>
      <p class="status-meta">
        If the app does not open, redeem the code inside Lythaus.
      </p>
      <noscript class="status-meta">
        Enable JavaScript to validate this invite and open the app.
      </noscript>
    </div>
  </section>

  <script>
    const status = document.getElementById('invite-status');
    const message = document.getElementById('invite-message');
    const openApp = document.getElementById('open-app');
    const copyButton = document.getElementById('copy-code');
    const apiBase = status?.dataset.apiBase || '';
    const deepLinkBase = status?.dataset.deeplinkBase || 'asora://invite/';

    function parseInviteCode() {
      const url = new URL(window.location.href);
      const queryCode = url.searchParams.get('code');
      const parts = url.pathname.split('/').filter(Boolean);
      const pathCode = parts.length > 1 ? parts[parts.length - 1] : null;
      if (queryCode) return queryCode;
      if (pathCode && pathCode.toLowerCase() !== 'invite') return pathCode;
      return '';
    }

    function setState(text, canOpen) {
      if (message) message.textContent = text;
      if (openApp) openApp.style.display = canOpen ? 'inline-flex' : 'none';
      if (copyButton) copyButton.style.display = canOpen ? 'inline-flex' : 'none';
    }

    async function validateInvite(code) {
      if (!code) {
        setState('Invite code is missing. Request a fresh link.', false);
        return;
      }
      const link = `${deepLinkBase}${encodeURIComponent(code)}`;
      if (openApp) openApp.setAttribute('href', link);

      try {
        const response = await fetch(
          `${apiBase}/api/auth/invite/validate?code=${encodeURIComponent(code)}`,
          { method: 'GET' }
        );
        if (!response.ok) {
          setState('Invite link could not be verified. Try again later.', false);
          return;
        }
        const payload = await response.json();
        const valid = payload?.data?.valid ?? payload?.valid;
        if (valid) {
          setState('Invite verified. Opening the app now.', true);
          window.location.href = link;
        } else {
          setState('Invite link could not be verified. Request a new invite.', false);
        }
      } catch (error) {
        setState('Invite link could not be verified. Try again later.', false);
      }
    }

    if (copyButton) {
      copyButton.addEventListener('click', async () => {
        const code = parseInviteCode();
        if (!code) return;
        try {
          await navigator.clipboard.writeText(code);
          setState('Invite code copied. Open the app to redeem it.', true);
        } catch (error) {
          setState('Copy failed. Select the code from the link manually.', true);
        }
      });
    }

    validateInvite(parseInviteCode());
  </script>
</BaseLayout>

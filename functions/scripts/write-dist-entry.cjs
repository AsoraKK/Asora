#!/usr/bin/env node
const fs = require('node:fs');
const path = require('node:path');

const distDir = path.join(__dirname, '..', 'dist');
const srcEntry = path.join(distDir, 'src', 'index.js');
const destEntry = path.join(distDir, 'index.js');
const srcTypes = path.join(distDir, 'src', 'index.d.ts');
const destTypes = path.join(distDir, 'index.d.ts');
const banner = '// Auto-generated by scripts/write-dist-entry.cjs\n';

if (!fs.existsSync(srcEntry)) {
  console.error('Expected build output missing at', srcEntry);
  process.exit(1);
}

fs.mkdirSync(distDir, { recursive: true });
const jsContent = `${banner}module.exports = require('./src/index.js');\n`;
fs.writeFileSync(destEntry, jsContent, 'utf8');

if (fs.existsSync(srcTypes)) {
  const typesContent = `${banner}export * from './src/index';\n`;
  fs.writeFileSync(destTypes, typesContent, 'utf8');
}

// Copy required Azure Functions files to dist root
const rootDir = path.join(__dirname, '..');
const filesToCopy = ['host.json', 'package.json'];

for (const file of filesToCopy) {
  const srcPath = path.join(rootDir, file);
  const destPath = path.join(distDir, file);

  if (fs.existsSync(srcPath)) {
    if (file === 'package.json') {
      // Fix the 'main' field for deployment (remove dist/ prefix)
      const pkg = JSON.parse(fs.readFileSync(srcPath, 'utf8'));
      if (pkg.main === 'dist/index.js') {
        pkg.main = 'index.js';
      }
      fs.writeFileSync(destPath, JSON.stringify(pkg, null, 2) + '\n', 'utf8');
      console.log(`Copied ${file} to dist/ (fixed main field)`);
    } else {
      fs.copyFileSync(srcPath, destPath);
      console.log(`Copied ${file} to dist/`);
    }
  } else {
    console.warn(`Warning: ${file} not found in root directory`);
  }
}

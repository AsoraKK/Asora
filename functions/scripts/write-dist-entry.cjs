#!/usr/bin/env node
const fs = require('node:fs');
const path = require('node:path');

const distDir = path.join(__dirname, '..', 'dist');
const srcEntry = path.join(distDir, 'src', 'index.js');
const destEntry = path.join(distDir, 'index.js');
const srcTypes = path.join(distDir, 'src', 'index.d.ts');
const destTypes = path.join(distDir, 'index.d.ts');
const banner = '// Auto-generated by scripts/write-dist-entry.cjs\n';

if (!fs.existsSync(srcEntry)) {
  console.error('Expected build output missing at', srcEntry);
  process.exit(1);
}

fs.mkdirSync(distDir, { recursive: true });

// Generated entrypoint: prefer the compiled bootstrap, but fall back to
// direct per-route requires if that fails so /api/health still comes up.
const fallbackModules = [
  './src/shared/routes/health',
  './src/shared/routes/ready',
  './src/feed/routes/getFeed',
  './src/feed/routes/createPost',
  './src/auth/routes/authorize',
  './src/auth/routes/getConfig',
  './src/auth/routes/ping',
  './src/auth/routes/token',
  './src/auth/routes/userinfo',
  './src/moderation/routes/flagContent',
  './src/moderation/routes/submitAppeal',
  './src/moderation/routes/voteOnAppeal',
  './src/privacy/routes/deleteUser',
  './src/privacy/routes/exportUser',
];

const jsContent = `${banner}(function bootstrap() {
  const modules = ${JSON.stringify(fallbackModules)};
  let healthRegistered = false;

  try {
    require('./src/index.js');
    healthRegistered = true;
  } catch (error) {
    const reason = error && error.message ? error.message : error;
    console.error('[bootstrap] Failed to load ./src/index.js:', reason);

    for (const mod of modules) {
      try {
        require(mod);
        if (mod.includes('/health')) {
          healthRegistered = true;
        }
        console.log('[bootstrap] Loaded fallback module:', mod);
      } catch (moduleError) {
        const detail = moduleError && moduleError.message ? moduleError.message : moduleError;
        console.error('[bootstrap] Failed to load fallback module', mod + ':', detail);
      }
    }
  }

  if (!healthRegistered) {
    console.error('[bootstrap] Health route did not register; deployment cannot serve /api/health.');
  }
})();\n`;
fs.writeFileSync(destEntry, jsContent, 'utf8');

if (fs.existsSync(srcTypes)) {
  const typesContent = `${banner}export * from './src/index';\n`;
  fs.writeFileSync(destTypes, typesContent, 'utf8');
}

// Copy required Azure Functions files to dist root
const rootDir = path.join(__dirname, '..');
const filesToCopy = ['host.json', 'package.json'];

for (const file of filesToCopy) {
  const srcPath = path.join(rootDir, file);
  const destPath = path.join(distDir, file);

  if (fs.existsSync(srcPath)) {
    if (file === 'package.json') {
      // Create a clean production package.json for deployment
      // - Set main to index.js
      // - Force type to commonjs (critical for Azure Functions Flex)
      // - Include only essential fields
      const pkg = JSON.parse(fs.readFileSync(srcPath, 'utf8'));
      const prodPkg = {
        name: pkg.name,
        version: pkg.version,
        private: true,
        type: 'commonjs',
        main: 'index.js',
        engines: pkg.engines,
        dependencies: pkg.dependencies
      };
      fs.writeFileSync(destPath, JSON.stringify(prodPkg, null, 2) + '\n', 'utf8');
      console.log(`Copied ${file} to dist/ (production CJS package)`);
    } else {
      fs.copyFileSync(srcPath, destPath);
      console.log(`Copied ${file} to dist/`);
    }
  } else {
    console.warn(`Warning: ${file} not found in root directory`);
  }
}

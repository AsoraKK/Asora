name: CI

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write

jobs:
  docs_placement:
    name: Check new markdown file placement
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check new markdown files are in docs/ directory
        run: |
          set -euo pipefail
          # Only check ADDED markdown files (not modified)
          ADDED_MD=$(git diff --name-only --diff-filter=A origin/${{ github.base_ref }}...HEAD -- '*.md' || true)
          ALLOWED_ROOT="^(README\.md|CONTRIBUTING\.md|CHANGELOG\.md|LICENSE\.md|CODE_OF_CONDUCT\.md|SECURITY\.md|AGENTS\.md)$"
          VIOLATIONS=""
          for file in $ADDED_MD; do
            # Allow docs tree
            if [[ "$file" =~ ^docs/ ]]; then
              continue
            fi
            # Allow README.md anywhere (module docs)
            if [[ "$(basename "$file")" == "README.md" ]]; then
              continue
            fi
            # Allow root-level standard files
            if [[ "$(basename "$file")" =~ $ALLOWED_ROOT ]]; then
              continue
            fi
            VIOLATIONS="$VIOLATIONS $file"
          done
          if [[ -n "$VIOLATIONS" ]]; then
            echo "âŒ New markdown files must be in docs/ directory:$VIOLATIONS"
            echo "ðŸ“ Use: docs/specs/, docs/guides/, docs/runbooks/, docs/adr/"
            exit 1
          fi
          echo "âœ… New markdown file placement OK"

  legal_register_validation:
    name: Validate legal operation registers
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate legal register files
        run: bash scripts/check_legal_registers.sh

  workflow_lint:
    name: Lint workflows (actionlint + shellcheck)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install dependencies (jq, shellcheck)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq shellcheck

      - name: Download actionlint
        run: |
          set -euo pipefail
          mkdir -p ./bin
          # use a pinned version for reproducibility; or replace with 'latest'
          curl -sSfL https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash \
          | bash -s -- 1.7.7 ./bin
          ./bin/actionlint -version

      - name: Run actionlint
        env:
          # Allow known benign ShellCheck classes used in scripts.
          SHELLCHECK_OPTS: "-e SC2086 -e SC2126"
        run: |
          set -euo pipefail
          ./bin/actionlint -color

  validate_extension_bundle:
    name: Validate Azure Functions extension bundle v4
    runs-on: ubuntu-latest
    needs: [workflow_lint]
    steps:
      - uses: actions/checkout@v4

      - name: Validate extension bundle version
        run: |
          set -euo pipefail
          # Check host.json contains [4.*, 5.0.0)
          BUNDLE_VERSION=$(jq -r '.extensionBundle.version' host.json)
          if [[ "$BUNDLE_VERSION" != "[4.*, 5.0.0)" ]]; then
            echo "âŒ Extension bundle must be [4.*, 5.0.0), found: $BUNDLE_VERSION"
            exit 1
          fi
          echo "âœ… Extension bundle version is correct: $BUNDLE_VERSION"

  openapi_validation:
    name: Lint OpenAPI spec
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: npm ci
        run: npm ci

      - name: Lint OpenAPI spec
        run: npm run openapi:lint

      - name: Bundle OpenAPI spec
        run: npm run openapi:bundle

      - name: Upload bundled spec
        uses: actions/upload-artifact@v4
        with:
          name: openapi-spec
          path: api/openapi/dist/openapi.json

  control_panel_build:
    name: Build Control Panel
    runs-on: ubuntu-latest
    needs: [workflow_lint]
    defaults:
      run:
        working-directory: apps/control-panel
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/control-panel/package-lock.json

      - name: npm ci
        run: npm ci

      - name: Build
        run: npm run build

      - name: Verify dist exists
        run: test -d "$GITHUB_WORKSPACE/apps/control-panel/dist" || { echo "apps/control-panel/dist missing"; exit 1; }

  marketing_site_build:
    name: Build Marketing Site
    runs-on: ubuntu-latest
    needs: [workflow_lint]
    defaults:
      run:
        working-directory: apps/marketing-site
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: apps/marketing-site/package-lock.json

      - name: Install dependencies
        run: |
          # Retry npm ci up to 3 times to handle esbuild ETXTBSY race condition
          attempt=0
          until npm ci; do
            attempt=$((attempt + 1))
            if [ "$attempt" -ge 3 ]; then
              echo "npm ci failed after 3 attempts"
              exit 1
            fi
            echo "Retry $attempt: clearing cache and node_modules..."
            rm -rf node_modules
            npm cache clean --force
            sleep 5
          done

      - name: Build
        env:
          PUBLIC_API_BASE_URL: ${{ secrets.PUBLIC_API_BASE_URL }}
        run: npm run build

      - name: Verify dist exists
        run: test -d "$GITHUB_WORKSPACE/apps/marketing-site/dist" || { echo "apps/marketing-site/dist missing"; exit 1; }

  secret-scan:
    name: Secret scan (gitleaks)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run gitleaks
        run: scripts/secret-scan.sh

  verify-secrets:
    name: Verify required secrets
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required secrets
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
          AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
        run: |
          set -euo pipefail
          for k in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID; do
            v="${!k:-}"
            [ -n "$v" ] || { echo "Missing secret: $k"; exit 1; }
          done

  flutter_tests:
    name: Flutter tests + coverage
    runs-on: ubuntu-latest
    needs: [workflow_lint]
    steps:
      - uses: actions/checkout@v4

      - uses: actions/cache@v4
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-pub-${{ hashFiles('**/pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.32.0'

      - name: Pub get
        run: flutter pub get

      - name: Enforce design system gate
        run: bash scripts/design_system_gate.sh

      - name: Regenerate golden files for CI environment
        run: flutter test --update-goldens test/design_system/

      - name: Test with coverage
        run: flutter test --coverage

      - name: Enforce coverage gates (P1, P2, Total baseline)
        id: coverage_gates
        continue-on-error: true
        run: |
          set -euo pipefail
          chmod +x scripts/check_coverage_gates.sh
          bash scripts/check_coverage_gates.sh 2>&1 | tee coverage_gates_output.txt

      - name: Prepare coverage summary
        run: |
          set -euo pipefail
          {
            echo "### Coverage Gates Report"
            echo
            echo '```'
            cat coverage_gates_output.txt 2>/dev/null || echo "Coverage summary unavailable"
            echo '```'
          } > code-coverage-results.md

      - name: Comment coverage on PR
        if: ${{ github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');
            const p = path.join(process.env.GITHUB_WORKSPACE || '.', 'code-coverage-results.md');
            const body = fs.existsSync(p) ? fs.readFileSync(p, 'utf8') : 'Coverage summary unavailable';
            const issue_number = context.payload.pull_request.number;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number,
              body
            });

      - name: Coverage summary (job summary)
        run: |
          set -euo pipefail
          echo "## Coverage" >> "$GITHUB_STEP_SUMMARY"
          if test -f code-coverage-results.md; then
            cat code-coverage-results.md >> "$GITHUB_STEP_SUMMARY"
          else
            echo "Coverage summary unavailable" >> "$GITHUB_STEP_SUMMARY"
          fi

      - name: Fail if coverage gates failed
        if: ${{ steps.coverage_gates.outcome == 'failure' }}
        run: |
          echo "Coverage gates failed; see output above for details."
          exit 1

  functions_build:
    name: Build Functions and package artifact
    runs-on: ubuntu-latest
    needs: [workflow_lint]
    defaults:
      run:
        working-directory: functions
    steps:
      - uses: actions/checkout@v4

      - name: Install jq for guards
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y jq

      - name: Guard host.json version (root + functions/**)
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          FILES=$(git ls-files -- 'host.json' 'functions/**/host.json' ':!:**/node_modules/**' ':!:**/*.md')
          [ -n "$FILES" ] || { echo "No host.json found"; exit 1; }
          for f in $FILES; do
            jq -e '(."version" == "2.0") or (has("version") == false)' "$f" >/dev/null \
              || { echo "Invalid host.json version in $f"; exit 1; }
          done

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Verify functions build script exists
        run: |
          set -euo pipefail
          jq -e '.scripts.build|length>0' package.json >/dev/null

      - name: npm ci (strict)
        run: npm ci

      - name: TypeScript type-check (fail fast)
        run: npm run typecheck

      - name: Run tests (if present)
        run: |
          set -euo pipefail
          if jq -e '.scripts.test|length>0' package.json >/dev/null 2>&1; then
            npm test
          else
            echo "No test script; skipping"
          fi

      - name: Build (TS -> dist)
        run: npm run build

      - name: Verify dist exists
        run: test -d "$GITHUB_WORKSPACE/functions/dist" || { echo "functions/dist missing"; exit 1; }

      - name: Package Azure Functions v4 zip
        shell: bash
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          ROOT="$GITHUB_WORKSPACE"
          echo "Packing v4 artifact..."
          rm -rf -- "$ROOT/deploy" "$ROOT/dist-v4-final.zip"
          mkdir -p "$ROOT/deploy"

          # Root host.json at zip root
          cp -- "$ROOT/host.json" "$ROOT/deploy/host.json"

          # functions package.json (for metadata)
          cp -- "$ROOT/functions/package.json" "$ROOT/deploy/"

          # compiled output: copy entire dist to preserve paths
          test -d "$ROOT/functions/dist" || { echo "functions/dist missing"; exit 1; }
          cp -R -- "$ROOT/functions/dist/." "$ROOT/deploy/"

          # thin entrypoint for v4 runtime
          cp -- "$ROOT/functions/runtime-index.js" "$ROOT/deploy/index.js"

          # function.json directories
          echo "Copying function.json directories..."
          for d in "$ROOT/functions"/*; do
            if [ -f "$d/function.json" ]; then
              bn=$(basename "$d")
              mkdir -p "$ROOT/deploy/$bn"
              cp -- "$d/function.json" "$ROOT/deploy/$bn/"
            fi
          done

          # production node_modules
          pushd "$ROOT/functions" >/dev/null
          npm ci --omit=dev
          popd >/dev/null
          cp -R -- "$ROOT/functions/node_modules" "$ROOT/deploy/node_modules"

          echo "Package contents:"
          find "$ROOT/deploy" -maxdepth 2 -type f -name "*.json" | sort

          (cd "$ROOT/deploy" && zip -r ../dist-v4-final.zip . -x "*.DS_Store" "*.git*" "Thumbs.db")

          echo "Created $ROOT/dist-v4-final.zip"

      - name: Upload feed workbook artifact
        uses: actions/upload-artifact@v4
        with:
          name: feed-workbook
          path: observability/workbooks/feed-latency.json

      - uses: actions/upload-artifact@v4
        with:
          name: functions-v4-artifact
          path: dist-v4-final.zip
          if-no-files-found: error

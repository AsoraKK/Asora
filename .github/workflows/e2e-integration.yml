---
name: E2E Integration Test

on:
  workflow_run:
    workflows: ["Deploy Functions (Flex)"]
    types: [completed]
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  verify-secrets:
    name: Verify Required Secrets
    runs-on: ubuntu-latest
    steps:
      - name: Ensure required secrets
        run: |
          for k in AZURE_CLIENT_ID AZURE_TENANT_ID AZURE_SUBSCRIPTION_ID; do
            case $k in
              AZURE_CLIENT_ID) v="${{ secrets.AZURE_CLIENT_ID }}" ;;
              AZURE_TENANT_ID) v="${{ secrets.AZURE_TENANT_ID }}" ;;
              AZURE_SUBSCRIPTION_ID) v="${{ secrets.AZURE_SUBSCRIPTION_ID }}" ;;
            esac
            [ -n "$v" ] || { echo "Missing secret: $k"; exit 1; }
          done

  e2e:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    needs: verify-secrets
    runs-on: ubuntu-latest
    environment: dev
    env:
      SUBS: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
      APP: asora-function-dev
      RG: asora-psql-flex
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Set AZURE_CONFIG_DIR
        shell: bash
        run: |
          echo "AZURE_CONFIG_DIR=${RUNNER_TEMP}/azure-${GITHUB_RUN_ID}" >> "$GITHUB_ENV"

      - name: Install dependencies (fallback)
        shell: bash
        run: |
          # Ensure jq and curl are available (ubuntu-latest should have them)
          command -v jq >/dev/null || sudo apt-get update && sudo apt-get install -y jq
          command -v curl >/dev/null || sudo apt-get update && sudo apt-get install -y curl

      - name: Clear MSAL cache
        shell: bash
        run: |
          # Clear MSAL cache to avoid AttributeError issues
          rm -rf ~/.azure/msal_token_cache.json || true
          rm -rf ~/.azure/accessTokens.json || true

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          subscription-id: ${{ secrets.AZURE_SUBSCRIPTION_ID }}

      - name: Auth sanity
        run: |
          set -euo pipefail
          echo "AZURE_CONFIG_DIR=${AZURE_CONFIG_DIR:-$HOME/.azure}"
          ls -la "${AZURE_CONFIG_DIR:-$HOME/.azure}" || true
          az account set --subscription "$SUBS"
          az account get-access-token --resource https://management.azure.com -o none
          az account show --output table

      - name: Discover keys & URL
        id: info
        shell: bash
        run: |
          set -Eeuo pipefail
          : "${SUBS:?}"; : "${RG:?}"; : "${APP:?}"

          # Sanity: token fetch
          echo "Verifying ARM access..."
          az account get-access-token --resource https://management.azure.com -o none

          API=2022-03-01
          APP_ID="/subscriptions/${SUBS}/resourceGroups/${RG}/providers/Microsoft.Web/sites/${APP}"
          APP_URL="https://management.azure.com${APP_ID}?api-version=${API}"

          echo "Getting function app details via ARM API..."
          APP_JSON=$(az rest --method get --url "$APP_URL" 2>arm.err || true)
          if ! jq -e . >/dev/null 2>&1 <<<"$APP_JSON"; then
            echo "::group::ARM error"; cat arm.err || true; echo "::endgroup::"
            echo "::error::Failed to GET site via ARM"; exit 1
          fi

          HOST=$(jq -r '.properties.defaultHostName // empty' <<<"$APP_JSON")
          [ -n "$HOST" ] || { echo "::error::defaultHostName missing"; exit 1; }

          echo "FUNCTION_BASE_URL=https://${HOST}" >> "$GITHUB_ENV"
          echo "BASE_URL=https://${HOST}" >> "$GITHUB_ENV"

          # Keys (graceful if RBAC insufficient)
          echo "Attempting key discovery..."
          KEYS_URL="https://management.azure.com${APP_ID}/host/default/listkeys?api-version=${API}"
          KEYS_JSON=$(az rest --method post --url "$KEYS_URL" --headers Content-Type=application/json --body "{}" 2>/dev/null || echo "{}")
          KEY=$(jq -r '.masterKey // .functionKeys.default // empty' <<<"$KEYS_JSON")
          [ -n "$KEY" ] || KEY="anonymous"
          [ "$KEY" = "anonymous" ] && echo "::warning::No admin key fetched - may lack RBAC permissions"
          echo "FUNCTION_KEY=${KEY}" >> "$GITHUB_ENV"
          echo "Resolved deployment endpoint: https://${HOST}"

      - name: "Wait for Function App readiness"
        shell: bash
        run: |
          set -euo pipefail

          APP_ID="/subscriptions/${SUBS}/resourceGroups/${RG}/providers/Microsoft.Web/sites/${APP}"
          get_state(){ az resource show --ids "$APP_ID" --query "properties.state" -o tsv 2>/dev/null || echo ""; }

          for i in $(seq 1 30); do
            STATE="$(get_state)"; echo "Attempt $i/30 state: ${STATE:-<empty>}"
            [ "$STATE" = "Running" ] && exit 0
            sleep 10
          done

          echo "::error::App not Running"; exit 1

      - name: Probe admin endpoints
        shell: bash
        run: |
          set -euo pipefail
          HOST="${FUNCTION_BASE_URL#https://}"
          KEY="${FUNCTION_KEY}"
          
          # Set up query params for authentication
          if [ "$KEY" != "anonymous" ]; then
            QP="?code=${KEY}"
          else
            QP=""
          fi
          
          echo "Probing admin endpoints on: $HOST"
          
          echo "=== GET /admin/host/status ==="
          curl -fsS "https://${HOST}/admin/host/status${QP}" | jq . || echo "Host status probe failed"
          
          echo "=== GET /admin/functions ==="
          FUNCTIONS_RESP=$(curl -fsS "https://${HOST}/admin/functions${QP}" || echo "[]")
          echo "$FUNCTIONS_RESP" | jq .
          FUNCTIONS_COUNT=$(echo "$FUNCTIONS_RESP" | jq length 2>/dev/null || echo "0")
          echo "Functions count: $FUNCTIONS_COUNT"
          
          if [ "$FUNCTIONS_COUNT" -lt 1 ]; then
            echo "::warning::Expected at least 1 function, found $FUNCTIONS_COUNT"
          fi

      - name: E2E
        run: |
          echo "Testing Function App at: $FUNCTION_BASE_URL"
          node scripts/e2e-itest.js

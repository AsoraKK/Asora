name: Deploy to asora-function-dev (Flex - storage publish)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-asora-function-dev-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  RG: asora-psql-flex
  FUNC_APP: asora-function-dev
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Block legacy SP secrets
        env:
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          set -euo pipefail
          if [ -n "${AZURE_CLIENT_SECRET:-}" ] || [ -n "${AZURE_CREDENTIALS:-}" ]; then
            echo "::error::Legacy Azure SP secret present. Migrate to OIDC only." >&2
            exit 1
          fi

      - name: Install zip utilities
        run: sudo apt-get update && sudo apt-get install -y zip unzip jq

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Key Vault references (preflight)
        uses: azure/cli@v2
        with:
          inlineScript: |
            bash .github/scripts/validate-kv-refs.sh "$RG" "$FUNC_APP"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Disable Husky in CI
        run: echo "HUSKY=0" >> "$GITHUB_ENV"

      - name: Build Functions
        working-directory: functions
        env:
          GIT_SHA: ${{ github.sha }}
        run: npm ci --no-audit --no-fund && npm run build

      - name: Gates (structure)
        working-directory: functions/dist
        run: |
          set -euo pipefail
          test -f host.json
          test -f index.js
          test -f health/function.json
          test -f health/index.js
          node -e "require('./health/index.js'); console.log('health ok')"
          zip -r ../functions-dist.zip .

      - name: Upload to deployment storage and publish
        run: |
          set -euo pipefail
          DEPLOY_VALUE=$(az functionapp show -g "$RG" -n "$FUNC_APP" --query "properties.functionAppConfig.deployment.storage.value" -o tsv)
          STG=$(echo "$DEPLOY_VALUE" | sed -n 's#https://\([^.]*\)\.blob\.core\.windows\.net/.*#\1#p')
          CONT=$(echo "$DEPLOY_VALUE" | sed -n 's#https://[^/]*/\([^?]*\).*#\1#p')
          az storage blob upload --auth-mode login --account-name "$STG" --container-name "$CONT" --name "functions-dist.zip" --file "functions/functions-dist.zip" --overwrite
          PACKAGE_URI="https://$STG.blob.core.windows.net/$CONT/functions-dist.zip"
          az rest --method post \
            --uri "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.Web/sites/$FUNC_APP/publish?api-version=2023-12-01" \
            --body "{\"type\":\"zip\",\"packageUri\":\"$PACKAGE_URI\"}"
          az functionapp restart -g "$RG" -n "$FUNC_APP"

      - name: Post-deploy probe
        run: |
          set -euo pipefail
          URL="https://${FUNC_APP}.azurewebsites.net/api/health"
          for i in $(seq 1 20); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "probe $i http=$code"
            [ "$code" = 200 ] && exit 0
            sleep $(( i<10 ? i*2 : 20 ))
          done
          echo "::error::Liveness failed"; exit 1

      - name: Tail logs on failure
        if: failure()
        run: az webapp log tail -g "$RG" -n "$FUNC_APP" --timeout 120 || true

  acceptance:
    runs-on: ubuntu-latest
    needs: deploy
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Acceptance checks
        run: |
          set -euo pipefail
          HEALTH_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${FUNC_APP}.azurewebsites.net/api/health")
          echo "health http=$HEALTH_CODE"
          if [ "$HEALTH_CODE" != "200" ]; then
            echo "::error::Expected 200 from /api/health" >&2
            exit 1
          fi

          BOGUS_CODE=$(curl -s -o /dev/null -w "%{http_code}" "https://${FUNC_APP}.azurewebsites.net/api/__bogus__")
          echo "bogus http=$BOGUS_CODE"
          if [ "$BOGUS_CODE" != "404" ]; then
            echo "::error::Expected 404 from /api/__bogus__" >&2
            exit 1
          fi

          ADMIN_KEY=$(az functionapp keys list -g "$RG" -n "$FUNC_APP" --query 'masterKey' -o tsv)
          if [ -z "$ADMIN_KEY" ]; then
            echo "::error::Failed to resolve function app master key" >&2
            exit 1
          fi

          COUNT=$(curl -s "https://${FUNC_APP}.azurewebsites.net/admin/functions" -H "x-functions-key: $ADMIN_KEY" | jq -r '.[].name' | grep -cx 'health' || true)
          echo "indexed health functions=$COUNT"
          if [ "$COUNT" != "1" ]; then
            echo "::error::Expected exactly one health function" >&2
            exit 1
          fi

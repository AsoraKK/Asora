name: Deploy to asora-function-dev (Flex - storage publish)

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-asora-function-dev-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  RG: asora-psql-flex
  FUNC_APP: asora-function-dev
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4

      - name: Block legacy SP secrets
        env:
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          set -euo pipefail
          if [ -n "${AZURE_CLIENT_SECRET:-}" ] || [ -n "${AZURE_CREDENTIALS:-}" ]; then
            echo "::error::Legacy Azure SP secret present. Migrate to OIDC only." >&2
            exit 1
          fi

      - name: Install zip utilities
        run: sudo apt-get update && sudo apt-get install -y zip unzip jq

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Validate Key Vault references (preflight)
        uses: azure/cli@v2
        with:
          inlineScript: |
            bash .github/scripts/validate-kv-refs.sh "$RG" "$FUNC_APP"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Disable Husky in CI
        run: echo "HUSKY=0" >> "$GITHUB_ENV"

      - name: Build function package (lockfile-safe dist)
        working-directory: functions
        env:
          GIT_SHA: ${{ github.sha }}
        run: |
          set -euo pipefail
          npm ci --no-audit --no-fund
          npm run build
          test -f dist/host.json || { echo "::error::dist/host.json missing"; ls -al dist; exit 1; }
          test -f dist/index.js || { echo "::error::dist/index.js missing"; ls -al dist; exit 1; }

          # Prod deps in dist
          if [ -f dist/package.json ]; then
            (cd dist && npm install --omit=dev --no-audit --no-fund)
          fi

          # Sanity: index.js must load without env (no top-level side effects)
          (cd dist && node -e "require('./index.js'); console.log('OK')") || { echo "::error::dist/index.js throws at load"; exit 1; }

          pushd dist >/dev/null
          zip -r ../dist-func.zip . -x "**/*.map" "**/*.ts" "__tests__/*" "tests/*"
          popd >/dev/null
          mv dist-func.zip "$GITHUB_WORKSPACE/dist-func.zip"

      - name: Validate package exists
        run: |
          set -euo pipefail
          test -f dist-func.zip || { echo "Missing dist-func.zip"; exit 3; }
          ls -lh dist-func.zip
          unzip -l dist-func.zip | head -n 60

      - name: Ensure Flex runtime configuration
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            CUR=$(az functionapp show -g "$RG" -n "$FUNC_APP" --query properties.functionAppConfig -o json || echo "{}")
            export CUR
            python3 - <<'PY' > body.json
            import json
            import os

            raw = os.environ.get("CUR", "{}")
            try:
              cfg = json.loads(raw) if raw else {}
            except json.JSONDecodeError:
              cfg = {}
            if not isinstance(cfg, dict):
              cfg = {}

            deployment = cfg.get("deployment")
            deployment_valid = False
            if isinstance(deployment, dict):
              storage = deployment.get("storage")
              if isinstance(storage, dict):
                dtype = storage.get("type")
                if isinstance(dtype, str) and dtype.strip():
                  deployment_valid = True

            clean_cfg = {
              "runtime": {"name": "node", "version": "20"},
              "scaleAndConcurrency": {"instanceMemoryMB": 2048, "maximumInstanceCount": 40}
            }

            clean_cfg["deployment"] = deployment if deployment_valid else None

            for key, value in cfg.items():
              if key in ("deployment", "runtime", "scaleAndConcurrency"):
                continue
              clean_cfg[key] = value

            print(json.dumps({"properties": {"functionAppConfig": clean_cfg}}))
            PY
            az rest --method patch \
              --uri "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.Web/sites/$FUNC_APP?api-version=2023-12-01" \
              --body @body.json >/dev/null

            # Core settings: extension version and rate limits enabled
            az functionapp config appsettings set -g "$RG" -n "$FUNC_APP" \
              --settings FUNCTIONS_EXTENSION_VERSION="~4" RATE_LIMITS_ENABLED="true" >/dev/null

      - name: Upload package to Storage and publish (Flex, no Kudu)
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail

            # Discover deployment storage from functionAppConfig
            DEPLOY_VALUE=$(az functionapp show -g "$RG" -n "$FUNC_APP" --query "properties.functionAppConfig.deployment.storage.value" -o tsv || true)
            if [ -z "$DEPLOY_VALUE" ]; then
              echo "::error::deployment.storage.value is not set on functionAppConfig; cannot publish package" >&2
              exit 1
            fi
            echo "deployment.storage.value=$DEPLOY_VALUE"

            # Parse storage account and container from URL like:
            #   https://<account>.blob.core.windows.net/<container>
            STG=$(echo "$DEPLOY_VALUE" | sed -n 's#https://\([^.]*\)\.blob\.core\.windows\.net/.*#\1#p')
            CONT=$(echo "$DEPLOY_VALUE" | sed -n 's#https://[^/]*/\([^?]*\).*#\1#p')
            if [ -z "$STG" ] || [ -z "$CONT" ]; then
              echo "::error::Failed to parse storage account/container from: $DEPLOY_VALUE" >&2
              exit 1
            fi
            echo "Using storage account=$STG container=$CONT"

            # Ensure Function App managed identity can read the container (best-effort)
            PRINCIPAL_ID=$(az functionapp identity show -g "$RG" -n "$FUNC_APP" --query principalId -o tsv || true)
            if [ -n "$PRINCIPAL_ID" ]; then
              SCOPE="$(az storage account show -g "$RG" -n "$STG" --query id -o tsv)/blobServices/default/containers/$CONT"
              az role assignment create \
                --assignee "$PRINCIPAL_ID" \
                --role "Storage Blob Data Reader" \
                --scope "$SCOPE" 2>/dev/null || echo "RBAC exists or could not be set (continuing)"
              # Allow time for RBAC to propagate
              sleep 15
            fi

            # Upload blob (using federated auth)
            BLOB_NAME="functionapp-${GITHUB_SHA:0:8}.zip"
            az storage blob upload \
              --auth-mode login \
              --account-name "$STG" \
              --container-name "$CONT" \
              --name "$BLOB_NAME" \
              --file "$GITHUB_WORKSPACE/dist-func.zip" \
              --overwrite 1>/dev/null
            PACKAGE_URI="https://$STG.blob.core.windows.net/$CONT/$BLOB_NAME"
            echo "Uploaded package to $PACKAGE_URI"

            # Publish via ARM API (Flex) with retry
            MAX_RETRIES=2
            for i in $(seq 1 $MAX_RETRIES); do
              if az rest --method post \
                --uri "/subscriptions/$AZURE_SUBSCRIPTION_ID/resourceGroups/$RG/providers/Microsoft.Web/sites/$FUNC_APP/publish?api-version=2023-12-01" \
                --body "{\"type\":\"zip\",\"packageUri\":\"$PACKAGE_URI\"}"; then
                echo "Publish succeeded on attempt $i"
                break
              elif [ "$i" -lt "$MAX_RETRIES" ]; then
                echo "Publish failed on attempt $i, retrying..."
                sleep 5
              else
                echo "::error::Publish failed after $MAX_RETRIES attempts" >&2
                exit 1
              fi
            done

            # Restart to ensure host picks up deployment
            az functionapp restart -g "$RG" -n "$FUNC_APP"

      - name: Validate critical app settings
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            echo "üîç Validating critical app settings that must be present..."
            
            SETTINGS=$(az functionapp config appsettings list -g "$RG" -n "$FUNC_APP" -o json)
            
            # Check FUNCTIONS_EXTENSION_VERSION
            EXT_VERSION=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="FUNCTIONS_EXTENSION_VERSION") | .value' || echo "")
            if [ "$EXT_VERSION" != "~4" ]; then
              echo "::error::FUNCTIONS_EXTENSION_VERSION must be ~4, found: ${EXT_VERSION:-NOT_SET}" >&2
              exit 1
            fi
            echo "‚úÖ FUNCTIONS_EXTENSION_VERSION: $EXT_VERSION"
            
            # Check that FUNCTIONS_WORKER_RUNTIME is NOT set (Flex requirement)
            WORKER_RUNTIME=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="FUNCTIONS_WORKER_RUNTIME") | .value' 2>/dev/null || echo "")
            if [ -n "$WORKER_RUNTIME" ]; then
              echo "::error::FUNCTIONS_WORKER_RUNTIME should NOT be set for Flex apps, found: $WORKER_RUNTIME" >&2
              exit 1
            fi
            echo "‚úÖ FUNCTIONS_WORKER_RUNTIME: not set (correct for Flex)"
            
            # Check Key Vault references are present
            EMAIL_HASH=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="EMAIL_HASH_SALT") | .value' || echo "")
            if [[ ! "$EMAIL_HASH" =~ ^@Microsoft\.KeyVault ]]; then
              echo "::warning::EMAIL_HASH_SALT is not a Key Vault reference: ${EMAIL_HASH:-NOT_SET}"
            else
              echo "‚úÖ EMAIL_HASH_SALT: Key Vault reference configured"
            fi
            
            COSMOS_CONN=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="COSMOS_CONNECTION_STRING") | .value' || echo "")
            if [[ ! "$COSMOS_CONN" =~ ^@Microsoft\.KeyVault ]]; then
              echo "::warning::COSMOS_CONNECTION_STRING is not a Key Vault reference: ${COSMOS_CONN:-NOT_SET}"
            else
              echo "‚úÖ COSMOS_CONNECTION_STRING: Key Vault reference configured"
            fi
            
            # Check Node version in runtime config
            RUNTIME_CONFIG=$(az functionapp show -g "$RG" -n "$FUNC_APP" --query "siteConfig" -o json)
            NODE_VERSION=$(echo "$RUNTIME_CONFIG" | jq -r '.linuxFxVersion' || echo "")
            echo "Runtime stack: ${NODE_VERSION:-not set}"
            
            if [[ ! "$NODE_VERSION" =~ [Nn]ode.*20 ]]; then
              echo "::warning::Runtime may not be Node 20. Current: $NODE_VERSION"
            else
              echo "‚úÖ Node 20 runtime detected"
            fi
            
            echo "‚úÖ Critical app settings validation complete"

      - name: Wait for runtime startup
        run: |
          set -euo pipefail
          HEALTH_URL="https://${FUNC_APP}.azurewebsites.net/api/health"
          PASSED=0
          
          echo "üîç Probing $HEALTH_URL with exponential backoff..."
          
          for i in $(seq 1 30); do
            # Capture both status code and response body for diagnostics
            RESPONSE=$(curl -sS "$HEALTH_URL" 2>&1 || echo "connection-failed")
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" 2>/dev/null || echo "000")
            
            echo "probe $i/$30: http=$CODE"
            
            if [ "$CODE" = "200" ]; then
              echo "‚úÖ Health check passed"
              PASSED=1
              break
            elif [ "$CODE" = "500" ] || [ "$CODE" = "503" ]; then
              # Log the error response for diagnosis
              echo "‚ö†Ô∏è  Server error response:"
              echo "$RESPONSE" | head -20
            fi
            
            # Exponential backoff: 2s, 4s, 6s, 8s, ... up to 60s max
            SLEEP_TIME=$((i * 2))
            if [ $SLEEP_TIME -gt 60 ]; then SLEEP_TIME=60; fi
            
            if [ $i -lt 30 ]; then
              echo "‚è≥ Waiting ${SLEEP_TIME}s before next probe..."
              sleep $SLEEP_TIME
            fi
          done
          
          if [ "$PASSED" -ne 1 ]; then
            echo "::error::Health check failed after 30 retries with exponential backoff." >&2
            echo "::error::Last response code: $CODE" >&2
            echo "::error::This indicates the Functions host is failing to start or /api/health is crashing." >&2
            exit 1
          fi

      - name: Stream App Insights logs on failure
        if: failure()
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            echo "üîç Streaming recent Application Insights logs..."
            
            # Get the last 50 traces and exceptions from App Insights
            APP_INSIGHTS_ID=$(az functionapp show -g "$RG" -n "$FUNC_APP" \
              --query "appSettings[?name=='APPINSIGHTS_INSTRUMENTATIONKEY'].value | [0]" -o tsv 2>/dev/null || echo "")
            
            if [ -n "$APP_INSIGHTS_ID" ]; then
              echo "üìä Recent exceptions and errors:"
              az monitor app-insights query \
                --app "$FUNC_APP" \
                --resource-group "$RG" \
                --analytics-query "union exceptions, traces | where timestamp > ago(10m) | order by timestamp desc | take 50 | project timestamp, severityLevel, message, outerMessage" \
                --output table 2>/dev/null || echo "Could not query App Insights"
            else
              echo "‚ö†Ô∏è  App Insights not configured, falling back to function app logs"
            fi
            
            echo ""
            echo "üìù Last 100 lines from function app logs:"
            az functionapp log tail -g "$RG" -n "$FUNC_APP" --timeout 10 2>&1 | tail -100 || echo "Log streaming unavailable"

      - name: Validate health endpoint (permanent)
        run: |
          set -euo pipefail
          HEALTH_URL="https://${FUNC_APP}.azurewebsites.net/api/health"
          echo "Validating $HEALTH_URL"
          
          RESPONSE=$(curl -sS "$HEALTH_URL")
          CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          
          if [ "$CODE" != "200" ]; then
            echo "::error::Health endpoint returned $CODE, expected 200" >&2
            echo "Response body: $RESPONSE" >&2
            exit 1
          fi
          
          # Validate required fields
          echo "$RESPONSE" | jq -e '.status == "ok"' >/dev/null || { echo "::error::Missing or invalid status field"; exit 1; }
          echo "$RESPONSE" | jq -e '.version' >/dev/null || { echo "::error::Missing version field"; exit 1; }
          echo "$RESPONSE" | jq -e '.uptimeSeconds' >/dev/null || { echo "::error::Missing uptimeSeconds field"; exit 1; }
          
          echo "‚úÖ Health endpoint validation passed"

      - name: Smoke test HTTP trigger
        run: |
          set -euo pipefail
          HEALTH_URL="https://${FUNC_APP}.azurewebsites.net/api/health"
          echo "GET $HEALTH_URL"
          RESPONSE=$(curl -sS "$HEALTH_URL")
          echo "$RESPONSE" | jq . || echo "$RESPONSE"
          code=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL")
          [ "$code" = "200" ] || { echo "::error::Health endpoint not 200 ($code)"; exit 1; }

      - name: Health endpoint cold-start regression test
        run: |
          set -euo pipefail
          HEALTH_URL="https://${FUNC_APP}.azurewebsites.net/api/health"
          echo "Running 3-minute cold-start regression test..."
          
          FAILURES=0
          for i in $(seq 1 3); do
            echo "Minute $i of 3..."
            CODE=$(curl -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" || echo "000")
            if [ "$CODE" != "200" ]; then
              echo "::warning::Health probe returned $CODE at minute $i"
              FAILURES=$((FAILURES + 1))
            fi
            [ "$i" -lt 3 ] && sleep 60
          done
          
          if [ "$FAILURES" -gt 0 ]; then
            echo "::error::Health endpoint failed $FAILURES times during cold-start test" >&2
            exit 1
          fi
          echo "‚úÖ Cold-start regression test passed"

      - name: Try to list functions (best-effort on Flex)
        if: always()
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            echo "=== Deployed Functions Inventory (may be empty on Flex API) ==="
            az functionapp function list -g "$RG" -n "$FUNC_APP" -o table || echo "function list unavailable on Flex"

      - name: Verify extension bundle v4 post-deployment
        uses: azure/cli@v2
        with:
          inlineScript: |
            set -euo pipefail
            echo "üîç Verifying extension bundle configuration..."
            
            # Verify FUNCTIONS_EXTENSION_VERSION is ~4
            EXT_VERSION=$(az functionapp config appsettings list \
              --name "$FUNC_APP" \
              --resource-group "$RG" \
              --query "[?name=='FUNCTIONS_EXTENSION_VERSION'].value | [0]" \
              --output tsv)
            
            if [[ "$EXT_VERSION" == "~4" ]]; then
              echo "‚úÖ FUNCTIONS_EXTENSION_VERSION: $EXT_VERSION"
            else
              echo "::error::FUNCTIONS_EXTENSION_VERSION should be ~4, found: ${EXT_VERSION:-NOT SET}"
              exit 1
            fi
            
            # Verify FUNCTIONS_WORKER_RUNTIME is NOT set (Flex requirement)
            WORKER_RUNTIME=$(az functionapp config appsettings list \
              --name "$FUNC_APP" \
              --resource-group "$RG" \
              --query "[?name=='FUNCTIONS_WORKER_RUNTIME'].value | [0]" \
              --output tsv || echo "")
            
            if [[ -z "$WORKER_RUNTIME" ]]; then
              echo "‚úÖ FUNCTIONS_WORKER_RUNTIME: not set (correct for Flex)"
            else
              echo "::warning::FUNCTIONS_WORKER_RUNTIME is set to '$WORKER_RUNTIME' - should not be set for Flex apps"
            fi
            
            echo "‚úÖ Extension bundle validation complete"

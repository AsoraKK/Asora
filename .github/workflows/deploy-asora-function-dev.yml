name: Deploy to asora-function-dev

on:
  push:
    branches: [main]
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

concurrency:
  group: deploy-asora-function-dev-${{ github.ref }}
  cancel-in-progress: true

env:
  AZURE_CLIENT_ID: ${{ vars.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ vars.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
  RESOURCE_GROUP: asora-psql-flex
  APP_NAME: asora-function-dev
  NODE_VERSION: '20'

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - uses: actions/checkout@v4.1.7

      - name: Block legacy SP secrets
        env:
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
        run: |
          set -euo pipefail
          if [ -n "${AZURE_CLIENT_SECRET:-}" ] || [ -n "${AZURE_CREDENTIALS:-}" ]; then
            echo "::error::Legacy Azure SP secret present. Migrate to OIDC only." >&2
            exit 1
          fi

      - name: Install jq, zip, unzip
        run: sudo apt-get update && sudo apt-get install -y jq zip unzip

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Node
        uses: actions/setup-node@v4.0.3
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Disable Husky in CI
        run: echo "HUSKY=0" >> "$GITHUB_ENV"

      - name: Build classic function.json package
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          WORK="$(mktemp -d)"; pushd "$WORK" >/dev/null

          # host.json with no route prefix (routes are /health, /feed directly)
          cat > host.json <<'JSON'
          {
            "version": "2.0",
            "extensions": {
              "http": {
                "routePrefix": ""
              }
            }
          }
          JSON

          # app-level package.json
          cat > package.json <<'JSON'
          {
            "name": "asora-functions",
            "version": "1.0.0",
            "private": true,
            "type": "commonjs",
            "dependencies": {}
          }
          JSON

          # Health function
          mkdir -p Health
          cat > Health/function.json <<'JSON'
          {
            "bindings": [
              {
                "authLevel": "anonymous",
                "type": "httpTrigger",
                "direction": "in",
                "name": "req",
                "methods": ["get"],
                "route": "health"
              },
              {
                "type": "http",
                "direction": "out",
                "name": "$return"
              }
            ]
          }
          JSON

          cat > Health/index.js <<'JS'
          module.exports = async function (context, req) {
            context.res = {
              status: 200,
              headers: { "content-type": "application/json" },
              body: { ok: true, timestamp: new Date().toISOString(), service: "asora-function-dev" }
            };
          };
          JS

          # Feed function
          mkdir -p Feed
          cat > Feed/function.json <<'JSON'
          {
            "bindings": [
              {
                "authLevel": "anonymous",
                "type": "httpTrigger",
                "direction": "in",
                "name": "req",
                "methods": ["get"],
                "route": "feed"
              },
              {
                "type": "http",
                "direction": "out",
                "name": "$return"
              }
            ]
          }
          JSON

          cat > Feed/index.js <<'JS'
          module.exports = async function (context, req) {
            const guest = req.query.guest === "1";
            const limit = parseInt(req.query.limit || "10", 10);
            
            context.res = {
              status: 200,
              headers: { "content-type": "application/json" },
              body: {
                data: [],
                meta: {
                  total: 0,
                  limit: limit,
                  offset: 0,
                  guest: guest
                }
              }
            };
          };
          JS

          # Verify structure
          echo "Package structure:"
          find . -type f | sort

          # zip it
          zip -qr "$GITHUB_WORKSPACE/asora-function-dev.zip" .
          popd >/dev/null
          echo "Built package: asora-function-dev.zip"

      - name: Validate package exists
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          test -f "asora-function-dev.zip" || { echo "Missing asora-function-dev.zip"; exit 3; }
          echo "Package size:"
          ls -lh asora-function-dev.zip
          echo "Package contents:"
          unzip -l asora-function-dev.zip

      - name: Clean up flex-incompatible app settings
        run: |
          echo "Removing runtime settings that break Flex Consumption..."
          az functionapp config appsettings delete -g "$RESOURCE_GROUP" -n "$APP_NAME" \
            --setting-names FUNCTIONS_WORKER_RUNTIME || echo "FUNCTIONS_WORKER_RUNTIME already absent"
          az functionapp config appsettings delete -g "$RESOURCE_GROUP" -n "$APP_NAME" \
            --setting-names WEBSITE_NODE_DEFAULT_VERSION || echo "WEBSITE_NODE_DEFAULT_VERSION already absent"

          echo "Removing WEBSITE_RUN_FROM_PACKAGE if present..."
          az functionapp config appsettings delete -g "$RESOURCE_GROUP" -n "$APP_NAME" \
            --setting-names WEBSITE_RUN_FROM_PACKAGE || echo "WEBSITE_RUN_FROM_PACKAGE already absent"

      - name: Upload package to blob storage for Flex Consumption
        working-directory: ${{ github.workspace }}
        run: |
          set -euo pipefail
          
          # Try to get storage account name from identity-based setting first
          STORAGE_ACCOUNT=$(az functionapp config appsettings list -g "$RESOURCE_GROUP" -n "$APP_NAME" \
            --query "[?name=='AzureWebJobsStorage__accountName'].value|[0]" -o tsv)
          
          # If not found, extract from connection string
          if [ -z "$STORAGE_ACCOUNT" ] || [ "$STORAGE_ACCOUNT" = "None" ]; then
            echo "Identity-based storage not configured, extracting from connection string..."
            CONNECTION_STRING=$(az functionapp config appsettings list -g "$RESOURCE_GROUP" -n "$APP_NAME" \
              --query "[?name=='AzureWebJobsStorage'].value|[0]" -o tsv)
            
            if [ -z "$CONNECTION_STRING" ] || [ "$CONNECTION_STRING" = "None" ]; then
              echo "::error::Cannot determine storage account. No AzureWebJobsStorage settings found."
              exit 1
            fi
            
            # Extract account name from connection string (AccountName=xxxxx;)
            STORAGE_ACCOUNT=$(echo "$CONNECTION_STRING" | sed -n 's/.*AccountName=\([^;]*\).*/\1/p')
            # Extract account key from connection string (AccountKey=xxxxx;)
            STORAGE_KEY=$(echo "$CONNECTION_STRING" | sed -n 's/.*AccountKey=\([^;]*\).*/\1/p')
            
            if [ -z "$STORAGE_ACCOUNT" ] || [ -z "$STORAGE_KEY" ]; then
              echo "::error::Cannot extract storage account name and key from connection string."
              exit 1
            fi
          else
            # For identity-based, we need to get the key differently
            echo "Using identity-based storage access..."
            STORAGE_KEY=$(az storage account keys list --account-name "$STORAGE_ACCOUNT" --query "[0].value" -o tsv)
          fi
          
          echo "Using storage account: $STORAGE_ACCOUNT"
          
          # Ensure deployments container exists
          az storage container create \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_KEY" \
            --name deployments \
            --only-show-errors || echo "Container already exists"
          
          # Upload package with a unique blob name
          BLOB_NAME="deploy-$(date +%Y%m%d-%H%M%S)-${GITHUB_SHA::7}.zip"
          echo "Uploading as: $BLOB_NAME"
          
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_KEY" \
            --container-name deployments \
            --name "$BLOB_NAME" \
            --file "asora-function-dev.zip" \
            --overwrite \
            --only-show-errors
          
          # Also upload as functionapp.zip (standard name for Flex)
          az storage blob upload \
            --account-name "$STORAGE_ACCOUNT" \
            --account-key "$STORAGE_KEY" \
            --container-name deployments \
            --name "functionapp.zip" \
            --file "asora-function-dev.zip" \
            --overwrite \
            --only-show-errors
          
          echo "✅ Package uploaded to blob storage"
          echo "BLOB_URL=https://${STORAGE_ACCOUNT}.blob.core.windows.net/deployments/$BLOB_NAME" >> "$GITHUB_ENV"

      - name: Restart function app
        run: |
          echo "Restarting to pick up new deployment..."
          az functionapp restart -g "$RESOURCE_GROUP" -n "$APP_NAME"
          echo "Waiting for app to start (Flex Consumption may take 30-60s)..."
          sleep 45

      - name: List deployed functions
        run: |
          echo "Listing deployed functions..."
          az functionapp function list -g "$RESOURCE_GROUP" -n "$APP_NAME" -o table || true

      - name: Assert functions are present
        run: |
          set -euo pipefail
          n=$(az functionapp function list -g "$RESOURCE_GROUP" -n "$APP_NAME" --query "length([])" -o tsv)
          echo "Found $n function(s)"
          if [ "$n" -lt 2 ]; then
            echo "::error::Expected at least health and feed functions. Found only $n."
            exit 1
          fi
          echo "✅ Functions deployed successfully"

      - name: Verify health endpoint
        run: |
          set -euo pipefail
          echo "Testing https://${APP_NAME}.azurewebsites.net/health"
          
          # Retry logic for Flex Consumption cold starts
          MAX_RETRIES=5
          RETRY_DELAY=10
          
          for i in $(seq 1 $MAX_RETRIES); do
            code=$(curl -s -o /dev/null -w '%{http_code}' "https://${APP_NAME}.azurewebsites.net/health")
            echo "Attempt $i/$MAX_RETRIES: Health HTTP $code"
            
            if [ "$code" = "200" ] || [ "$code" = "204" ]; then
              echo "✅ Health endpoint responding"
              exit 0
            fi
            
            if [ $i -lt $MAX_RETRIES ]; then
              echo "Waiting ${RETRY_DELAY}s before retry..."
              sleep $RETRY_DELAY
            fi
          done
          
          echo "::error::Health check failed after $MAX_RETRIES attempts (last code: $code)"
          exit 1

      - name: Verify feed endpoint
        run: |
          set -euo pipefail
          echo "Testing https://${APP_NAME}.azurewebsites.net/feed?guest=1&limit=10"
          
          code=$(curl -s -o /dev/null -w '%{http_code}' "https://${APP_NAME}.azurewebsites.net/feed?guest=1&limit=10")
          echo "Feed HTTP: $code"
          
          if [ "$code" = "200" ] || [ "$code" = "204" ]; then
            echo "✅ Feed endpoint responding"
          else
            echo "::warning::Feed endpoint returned $code (may need warm-up)"
          fi

      - name: Display function URLs
        run: |
          echo "Deployed function URLs:"
          echo "  Health: https://${APP_NAME}.azurewebsites.net/health"
          echo "  Feed:   https://${APP_NAME}.azurewebsites.net/feed"

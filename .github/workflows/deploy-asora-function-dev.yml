name: deploy-asora-function-dev

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]
    paths:
      - "functions/**"
      - ".github/workflows/deploy-asora-function-dev.yml"

permissions:
  id-token: write

env:
  AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
  AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
  AZURE_SUBSCRIPTION_ID: ${{ secrets.AZURE_SUBSCRIPTION_ID }}
  RG: asora-psql-flex
  FUNC_APP: asora-function-dev
  NODE_VERSION: 20

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build Functions (Flex)
        working-directory: functions
        env:
          HUSKY: 0
          GIT_SHA: ${{ github.sha }}
        run: npm ci --no-audit --no-fund && npm run build

      - name: Gate artifact structure
        working-directory: functions/dist
        run: |
          set -euo pipefail
          echo "Validating Flex package structure..."
          test -f host.json || { echo "::error::Missing host.json"; exit 1; }
          test -f package.json || { echo "::error::Missing package.json"; exit 1; }
          test -f index.js || { echo "::error::Missing root index.js entrypoint"; exit 1; }
          test -f health/function.json || { echo "::error::Missing health/function.json"; exit 1; }
          test -f health/index.js || { echo "::error::Missing health/index.js"; exit 1; }
          MAIN=$(jq -r .main package.json)
          echo "package.json main field: $MAIN"
          if [ "$MAIN" != "index.js" ]; then
            echo "::error::Expected main=index.js, got: $MAIN"; exit 1
          fi
          echo "Smoke-testing classic health entrypoint..."
          node -e "require('./health/index.js'); console.log('âœ… Classic health loads successfully')"
          echo "Verifying index.js is safe (health-only)..."
          grep -q "require('./health/index.js')" index.js || { echo "::error::index.js doesn't load health"; exit 1; }
          echo "âœ… All structure gates passed"

      - name: Zip dist root (zip the CONTENTS of dist)
        working-directory: functions/dist
        run: zip -r ../../functions-dist.zip .

      - name: Publish to Flex (storage-backed + syncfunctiontriggers)
        run: |
          set -euo pipefail
          
          # Strip CRLF from all variables to prevent %0D in REST URLs
          SUBS=$(az account show --query id -o tsv | tr -d '\r')
          RG_CLEAN=$(echo "$RG" | tr -d '\r')
          FUNC_APP_CLEAN=$(echo "$FUNC_APP" | tr -d '\r')
          
          DEPLOY_VALUE=$(az functionapp show -g "$RG_CLEAN" -n "$FUNC_APP_CLEAN" --query "properties.functionAppConfig.deployment.storage.value" -o tsv | tr -d '\r')
          if [ -z "$DEPLOY_VALUE" ]; then
            echo "::error::Function App is not Flex or deployment storage not configured"; exit 1
          fi
          
          STG=$(echo "$DEPLOY_VALUE" | sed -n 's#https://\([^.]*\)\.blob\.core\.windows\.net/.*#\1#p')
          CONT=$(echo "$DEPLOY_VALUE" | sed -n 's#https://[^/]*/\([^/]*\)/.*#\1#p')
          BLOB=$(echo "$DEPLOY_VALUE" | sed -n 's#https://[^/]*/[^/]*/\([^?]*\).*#\1#p')
          
          echo "Storage: $STG, Container: $CONT, Blob: $BLOB"
          
          # Upload package to deployment storage
          az storage blob upload --auth-mode login \
            --account-name "$STG" \
            --container-name "$CONT" \
            --name "$BLOB" \
            --file "functions-dist.zip" \
            --overwrite
          
          # Trigger Flex runtime to reindex functions (using clean subscription ID)
          echo "Triggering function sync..."
          az rest --method post \
            --uri "https://management.azure.com/subscriptions/$SUBS/resourceGroups/$RG_CLEAN/providers/Microsoft.Web/sites/$FUNC_APP_CLEAN/syncfunctiontriggers?api-version=2023-12-01" \
            --verbose
          
          # Restart to force package reload
          echo "Restarting function app..."
          az functionapp restart -g "$RG_CLEAN" -n "$FUNC_APP_CLEAN"
          
          echo "Waiting 15s for host startup..."
          sleep 15

      - name: Validate Flex app settings
        run: |
          set -euo pipefail
          SETTINGS=$(az functionapp config appsettings list -g "$RG" -n "$FUNC_APP" -o json)
          EXT_VERSION=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="FUNCTIONS_EXTENSION_VERSION") | .value' || echo "")
          if [ "$EXT_VERSION" != "~4" ]; then
            echo "::error::FUNCTIONS_EXTENSION_VERSION must be ~4, found: ${EXT_VERSION:-NOT_SET}"; exit 1
          fi
          # Flex: FUNCTIONS_WORKER_RUNTIME should NOT be set
          WORKER=$(echo "$SETTINGS" | jq -r '.[] | select(.name=="FUNCTIONS_WORKER_RUNTIME") | .value' || echo "")
          if [ -n "$WORKER" ]; then
            echo "::error::FUNCTIONS_WORKER_RUNTIME must be unset on Flex, found: $WORKER"; exit 1
          fi

      - name: Post-deploy probe /api/health
        run: |
          set -euo pipefail
          
          # Strip CRLF from variables
          RG_CLEAN=$(echo "$RG" | tr -d '\r')
          FUNC_APP_CLEAN=$(echo "$FUNC_APP" | tr -d '\r')
          
          URL="https://${FUNC_APP_CLEAN}.azurewebsites.net/api/health"
          BOGUS_URL="https://${FUNC_APP_CLEAN}.azurewebsites.net/api/__bogus__"
          
          echo "Hard runtime gates per Flex validation requirements..."
          
          # Gate 1: Health returns 200
          for i in $(seq 1 20); do
            code=$(curl -s -o /dev/null -w "%{http_code}" "$URL" || true)
            echo "Gate 1 - probe $i: /api/health returned HTTP $code"
            if [ "$code" = "200" ]; then
              echo "âœ… Gate 1 passed: health=200"
              break
            fi
            if [ "$i" -eq 20 ]; then
              echo "::error::Gate 1 FAILED: /api/health never returned 200"
              exit 1
            fi
            sleep $(( i<10 ? i*2 : 20 ))
          done
          
          # Gate 2: Bogus route returns 404 (not 500)
          bogus_code=$(curl -s -o /dev/null -w "%{http_code}" "$BOGUS_URL" || true)
          echo "Gate 2 - bogus route returned HTTP $bogus_code"
          if [ "$bogus_code" = "404" ]; then
            echo "âœ… Gate 2 passed: bogus=404 (host is routing correctly)"
          else
            echo "::error::Gate 2 FAILED: Expected 404, got $bogus_code (host may not be routing)"
            exit 1
          fi
          
          # Gate 3: Admin /functions lists exactly one function: health
          ADMIN_KEY=$(az functionapp keys list -g "$RG_CLEAN" -n "$FUNC_APP_CLEAN" --query masterKey -o tsv | tr -d '\r')
          FUNCTIONS=$(curl -s -H "x-functions-key: $ADMIN_KEY" "https://${FUNC_APP_CLEAN}.azurewebsites.net/admin/functions" || echo "[]")
          FUNC_COUNT=$(echo "$FUNCTIONS" | jq -r '. | length')
          FUNC_NAMES=$(echo "$FUNCTIONS" | jq -r '.[].name' | tr '\n' ' ')
          echo "Gate 3 - indexed functions ($FUNC_COUNT): $FUNC_NAMES"
          
          if echo "$FUNC_NAMES" | grep -q "health"; then
            echo "âœ… Gate 3 passed: 'health' function indexed"
          else
            echo "::error::Gate 3 FAILED: 'health' not found in indexed functions"
            echo "Full admin response: $FUNCTIONS"
            exit 1
          fi
          
          echo "ðŸŽ‰ All hard runtime gates passed!"

      - name: Diagnostic logs on failure
        if: failure()
        run: |
          set +e  # Continue on error for diagnostics
          RG_CLEAN=$(echo "$RG" | tr -d '\r')
          FUNC_APP_CLEAN=$(echo "$FUNC_APP" | tr -d '\r')
          echo "Fetching recent Application Insights traces..."
          az monitor app-insights query \
            --app "$FUNC_APP_CLEAN" \
            --analytics-query "traces | where timestamp > ago(15m) | project timestamp, message, severityLevel | order by timestamp desc | take 50" \
            --offset 15m || echo "App Insights query not available"
          
          echo "Fetching indexed functions..."
          ADMIN_KEY=$(az functionapp keys list -g "$RG_CLEAN" -n "$FUNC_APP_CLEAN" --query masterKey -o tsv | tr -d '\r' || echo "")
          if [ -n "$ADMIN_KEY" ]; then
            curl -s -H "x-functions-key: $ADMIN_KEY" "https://${FUNC_APP_CLEAN}.azurewebsites.net/admin/functions" | jq '.' || true
          fi

  acceptance:
    runs-on: ubuntu-latest
    needs: deploy
    steps:
      - uses: actions/checkout@v4

      - name: Azure login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Acceptance checks (Flex)
        run: |
          set -euo pipefail
          BASE="https://${FUNC_APP}.azurewebsites.net"

          # 1) Liveness must be 200
          curl -s -o /dev/null -w "%{http_code}\n" "$BASE/api/health" | grep -qx 200

          # 2) Bogus route must be 404
          curl -s -o /dev/null -w "%{http_code}\n" "$BASE/api/__bogus__" | grep -qx 404

          # 3) Exactly one indexed 'health'
          ADMIN_KEY=$(az functionapp keys list -g "$RG" -n "$FUNC_APP" --query 'masterKey' -o tsv)
          curl -s "$BASE/admin/functions" -H "x-functions-key: $ADMIN_KEY" | jq -r '.[].name' | grep -cx 'health' | grep -qx 1
#!/usr/bin/env bash
# Pre-push hook - Runs full CI parity check before push
# This prevents pushing code that will fail in GitHub Actions

set -euo pipefail

# Load nvm if available
if [ -d "$HOME/.nvm" ]; then
  export NVM_DIR="$HOME/.nvm"
  [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"
  [ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"
  
  # Use Node.js 20 if available
  if nvm ls 20 >/dev/null 2>&1; then
    nvm use 20 >/dev/null || true
  fi
fi

echo "üîí Pre-push hook: Running CI parity checks"
echo "=========================================="

# Check if we're in the right directory
if [[ ! -f "ci-local.sh" ]]; then
    echo "‚ùå ci-local.sh not found. Run this from repository root."
    exit 1
fi

# Run the full CI verification
if ! bash ./ci-local.sh; then
    echo ""
    echo "‚ùå Pre-push hook FAILED"
    echo "======================="
    echo "Your push has been blocked because it would fail CI."
    echo ""
    echo "Common fixes:"
    echo "‚Ä¢ Formatting: run 'dart format .' and commit"
    echo "‚Ä¢ TS errors: fix code under functions/src/** and re-run"
    echo "‚Ä¢ Node version: use 'nvm use 20' before function steps"
    echo "‚Ä¢ Port in use: change to --port 7073 in ci-local.sh"
    echo ""
    echo "After fixing, run './ci-local.sh' manually to verify."
    exit 1
fi

echo ""
echo "‚úÖ Pre-push hook PASSED"
echo "======================"
echo "All CI parity checks successful - push will likely succeed!"

openapi: 3.1.0
info:
  title: Asora API
  version: v1
  description: HTTP contract for Asora Functions v1.
  license:
    name: MIT
    identifier: MIT
servers:
  - url: https://asora-function-dev-c3fyhqcfctdddfa2.northeurope-01.azurewebsites.net
    description: Azure Functions staging edge endpoint
  - url: https://${STAGING_DOMAIN}
    description: Asora staging domain (set via environment)
    variables:
      STAGING_DOMAIN:
        default: asora.example.com
        description: Injected staging domain hostname
tags:
  - name: Feed
    description: Feed retrieval endpoints.
  - name: Health
    description: Liveness monitoring endpoints.
  - name: Posts
    description: Post authoring endpoints.
  - name: Moderation
    description: Moderation workflows.
  - name: Privacy
    description: User data and privacy controls.
  - name: Privacy Admin
    description: Data Subject Request and legal hold administration.
paths:
  /feed:
    get:
      operationId: getFeed
      summary: Retrieve personalized feed items
      description: Return a page of feed items.
      tags:
        - Feed
      security:
        - bearerAuth: []
      parameters:
        - name: cursor
          in: query
          description: Cursor for pagination
          required: false
          schema:
            type: string
        - name: limit
          in: query
          description: Number of items to return (1-50)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 50
      responses:
        '200':
          description: Feed items retrieved successfully
          content:
            application/json:
              schema:
                type: object
                required:
                  - items
                  - meta
                properties:
                  items:
                    type: array
                    items:
                      type: object
                      additionalProperties: true
                  meta:
                    type: object
                    required:
                      - count
                    properties:
                      count:
                        type: integer
                        minimum: 0
                      nextCursor:
                        type:
                          - string
                          - 'null'
                      timingsMs:
                        type: object
                        additionalProperties:
                          type: number
                      applied:
                        type: object
                        additionalProperties: true
        '400':
          description: Invalid query parameters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Authenticated caller lacks required permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit enforced
          headers:
            Retry-After:
              description: Seconds until the client may retry
              schema:
                type: integer
                minimum: 0
            X-RateLimit-Limit:
              description: Maximum requests allowed in the enforced window
              schema:
                type: integer
            X-RateLimit-Remaining:
              description: Remaining requests before hitting the limit
              schema:
                type: integer
            X-RateLimit-Reset:
              description: Unix epoch seconds when the window resets
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
  /health:
    get:
      operationId: getHealth
      summary: Service health probe
      description: Liveness/readiness check. No auth.
      tags:
        - Health
      security: []
      responses:
        '200':
          description: Health status payload
          content:
            application/json:
              schema:
                type: object
                properties:
                  ok:
                    type: boolean
                  status:
                    type: string
                  timestamp:
                    type: string
                    format: date-time
                  service:
                    type: string
                  version:
                    type: string
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Rate limit enforced
          headers:
            Retry-After:
              description: Seconds until the client may retry
              schema:
                type: integer
                minimum: 0
            X-RateLimit-Limit:
              description: Maximum requests allowed in the enforced window
              schema:
                type: integer
            X-RateLimit-Remaining:
              description: Remaining requests before hitting the limit
              schema:
                type: integer
            X-RateLimit-Reset:
              description: Unix epoch seconds when the window resets
              schema:
                type: integer
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RateLimitError'
  /post:
    post:
      operationId: createPost
      summary: Create a new post
      description: Create a new post.
      tags:
        - Posts
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - id
                - text
              properties:
                id:
                  type: string
                  format: uuid
                  description: Client generated UUID v7 for the new post
                  example: 018b27d4-5b3b-73e3-bf77-bf7bb9530f21
                text:
                  type: string
                  description: Post body text
                  maxLength: 2000
                attachments:
                  type: array
                  description: Optional media attachments
                  items:
                    type: string
                    format: uri
      responses:
        '201':
          description: Post created successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                    format: uuid
                    example: 018b27d4-7f9b-7d9e-bf0e-9bf93c3fce43
                  status:
                    type: string
                    enum:
                      - published
                      - under_review
                      - rejected
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Authenticated caller lacks required permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /moderation/flag:
    post:
      operationId: flagContent
      summary: Flag content for moderation review
      description: Flag content for review.
      tags:
        - Moderation
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - targetId
                - reason
              properties:
                targetId:
                  type: string
                  format: uuid
                  description: Identifier of the content being flagged
                  example: 018b27d4-6e1e-7bd3-bb5a-98f24bb968c2
                reason:
                  type: string
                  description: Moderation reason
                  enum:
                    - spam
                    - harassment
                    - hate_speech
                    - violence
                    - adult_content
                    - misinformation
                    - copyright
                    - privacy
                    - other
                notes:
                  type: string
                  description: Additional details supporting the flag
                  maxLength: 1000
      responses:
        '202':
          description: Flag accepted for review
          content:
            application/json:
              schema:
                type: object
                properties:
                  flagId:
                    type: string
                    format: uuid
                    example: 018b27d4-83fd-7fff-b5e1-8e779ebf8eab
                  status:
                    type: string
                    enum:
                      - queued
                      - received
        '400':
          description: Invalid payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Missing or invalid authentication
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Authenticated caller lacks required permissions
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /admin/dsr/export:
    post:
      operationId: enqueueDsrExport
      summary: Enqueue a Data Subject Request export
      tags:
        - Privacy Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DsrRequestInput'
      responses:
        '202':
          description: Export queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrRequestSummary'
  /admin/dsr/delete:
    post:
      operationId: enqueueDsrDelete
      summary: Enqueue a Data Subject Request delete
      tags:
        - Privacy Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DsrRequestInput'
      responses:
        '202':
          description: Delete queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrRequestSummary'
  /admin/legal-hold/place:
    post:
      operationId: placeLegalHold
      summary: Place a legal hold
      tags:
        - Privacy Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LegalHoldInput'
      responses:
        '201':
          description: Hold placed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHoldRecord'
  /admin/legal-hold/clear:
    post:
      operationId: clearLegalHold
      summary: Clear an existing legal hold
      tags:
        - Privacy Admin
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LegalHoldClear'
      responses:
        '200':
          description: Hold cleared
        '404':
          description: Hold not found
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Error:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          description: Machine readable error code
        message:
          type: string
          description: Human readable error description
    RateLimitError:
      type: object
      required:
        - error
        - scope
        - limit
        - window_seconds
        - retry_after_seconds
        - trace_id
      properties:
        error:
          type: string
          description: Constant identifier for rate limit breaches
          enum:
            - rate_limited
        scope:
          type: string
          description: Scope of the limit that triggered the breach
          enum:
            - ip
            - user
            - route
            - auth_backoff
        limit:
          type: integer
          minimum: 0
          description: Maximum requests permitted within the window
        window_seconds:
          type: integer
          minimum: 1
          description: Window size for the limit in seconds
        retry_after_seconds:
          type: integer
          minimum: 0
          description: Seconds until the limit resets
        trace_id:
          type: string
          description: Correlation identifier for tracing
        reason:
          type: string
          description: Additional context for specialized scopes (e.g. auth backoff)
          enum:
            - auth_backoff
    DsrRequestSummary:
      type: object
      properties:
        id: { type: string }
        status:
          type: string
          enum: [ queued, running, awaiting_review, ready_to_release, released, succeeded, failed, canceled ]
        type:
          type: string
          enum: [ export, delete ]
        exportBlobPath: { type: string }
        attemptedAt: { type: string, format: date-time }
    LegalHoldRecord:
      type: object
      properties:
        id: { type: string }
        scope: { type: string }
        scopeId: { type: string }
        reason: { type: string }
    DsrRequestInput:
      type: object
      required: [ userId ]
      properties:
        userId:
          type: string
        note: { type: string }
    LegalHoldInput:
      type: object
      required: [ scope, scopeId, reason ]
      properties:
        scope:
          type: string
          enum: [ user, post, case ]
        scopeId: { type: string }
        reason: { type: string }
    LegalHoldClear:
      type: object
      required: [ id ]
      properties:
        id: { type: string }

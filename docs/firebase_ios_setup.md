# Firebase iOS Setup Guide

## Overview

This guide covers the iOS-specific Firebase Cloud Messaging (FCM) setup for the Asora app. After completing Android configuration, iOS requires additional setup including downloading the iOS config file from Firebase Console and verifying Apple Push Notification Service (APNs) credentials.

## Prerequisites

- Firebase Console access for project `asora-dev`
- Apple Developer account with APNs key or certificate
- iOS development environment configured
- Bundle ID: `com.asora.app`

---

## Step 1: Download iOS Configuration File

### 1.1 Add iOS App to Firebase Project

1. Go to [Firebase Console](https://console.firebase.google.com/)
2. Select project: **asora-dev**
3. Click gear icon (⚙️) → **Project Settings**
4. Scroll to **Your apps** section
5. Click **Add app** → Select **iOS** icon
6. Enter Bundle ID: `com.asora.app`
   - ⚠️ Must match exactly with Android package name
   - ⚠️ Cannot be changed after registration
7. (Optional) Enter App nickname: `Asora iOS`
8. (Optional) Enter App Store ID: Leave blank if not published
9. Click **Register app**

### 1.2 Download Configuration File

1. After registration, Firebase shows **Download GoogleService-Info.plist**
2. Click **Download GoogleService-Info.plist**
3. Save the file (typically `~/Downloads/GoogleService-Info.plist`)

### 1.3 Place Configuration File

```bash
# Copy file to iOS project
cp ~/Downloads/GoogleService-Info.plist /home/kylee/asora/ios/Runner/GoogleService-Info.plist

# Verify file exists
ls -l /home/kylee/asora/ios/Runner/GoogleService-Info.plist
```

Expected output:
```
-rw-r--r-- 1 kylee kylee 821 Nov 24 19:30 .../ios/Runner/GoogleService-Info.plist
```

---

## Step 2: Disable Firebase Analytics

### 2.1 Update Info.plist

Firebase Analytics must be disabled per privacy requirements (ADR 001). Add the following to `ios/Runner/Info.plist`:

```xml
<key>FirebaseAnalyticsCollectionEnabled</key>
<false/>
<key>FIREBASE_ANALYTICS_COLLECTION_DEACTIVATED</key>
<true/>
```

### 2.2 Verify Analytics Disabled

```bash
# Check for Analytics disable flag
grep -A1 "FirebaseAnalyticsCollectionEnabled" ios/Runner/Info.plist

# Should output:
# <key>FirebaseAnalyticsCollectionEnabled</key>
# <false/>
```

---

## Step 3: Configure APNs in Firebase Console

Firebase uses APNs to deliver push notifications on iOS. You must upload APNs credentials to Firebase.

### 3.1 Option A: APNs Authentication Key (Recommended)

1. **Create APNs Key in Apple Developer Portal**:
   - Go to [Apple Developer Certificates, Identifiers & Profiles](https://developer.apple.com/account/resources/certificates)
   - Click **Keys** → **+** (Create a new key)
   - Enter Key Name: `Asora APNs Key`
   - Check **Apple Push Notifications service (APNs)**
   - Click **Continue** → **Register**
   - **Download** the `.p8` key file (⚠️ can only download once!)
   - Note the **Key ID** (e.g., `AB12CD34EF`)
   - Note your **Team ID** (top right, e.g., `XY98ZW76UV`)

2. **Upload to Firebase Console**:
   - Firebase Console → **asora-dev** → **Project Settings**
   - Go to **Cloud Messaging** tab
   - Under **Apple app configuration**, find your iOS app
   - Click **Upload** next to **APNs Authentication Key**
   - Upload the `.p8` file
   - Enter **Key ID**: `AB12CD34EF`
   - Enter **Team ID**: `XY98ZW76UV`
   - Click **Upload**

### 3.2 Option B: APNs Certificate (Legacy)

If you prefer using certificates instead of keys:

1. **Create APNs Certificate in Apple Developer Portal**:
   - Go to [Apple Developer Certificates](https://developer.apple.com/account/resources/certificates)
   - Click **+** (Create a certificate)
   - Select **Apple Push Notification service SSL (Sandbox & Production)**
   - Select your App ID: `com.asora.app`
   - Upload Certificate Signing Request (CSR)
   - Download the `.cer` certificate
   - Import into Keychain Access (Mac only)
   - Export as `.p12` with password

2. **Upload to Firebase Console**:
   - Firebase Console → **asora-dev** → **Project Settings** → **Cloud Messaging**
   - Under **APNs Certificates**, click **Upload**
   - Select `.p12` file
   - Enter the password you set during export
   - Click **Upload**

---

## Step 4: Verify Flutter Firebase Packages

Flutter packages are already configured in `pubspec.yaml`:

```yaml
dependencies:
  firebase_core: ^3.8.1
  firebase_messaging: ^15.1.3
```

No additional dependencies needed. The iOS platform-specific code is auto-generated by Flutter.

---

## Step 5: Test iOS Build

### 5.1 Clean and Build

```bash
cd /home/kylee/asora

# Clean previous build artifacts
flutter clean
flutter pub get

# Build iOS (requires macOS)
flutter build ios --debug
```

### 5.2 Expected Build Output

Look for Firebase initialization logs:
```
[Firebase] Configured Firebase
[Firebase/Messaging] FCM SDK version: 10.x.x
[Firebase/Core] No analytics collection (disabled)
```

### 5.3 Troubleshooting

**Error: "GoogleService-Info.plist not found"**
- Verify file exists: `ls ios/Runner/GoogleService-Info.plist`
- Ensure file is in correct location (not in subdirectory)

**Error: "Missing APNs entitlement"**
- Xcode → Signing & Capabilities → Add **Push Notifications** capability
- Add **Background Modes** → Check **Remote notifications**

**Error: "Firebase configuration invalid"**
- Verify `BUNDLE_ID` in `GoogleService-Info.plist` matches `com.asora.app`
- Re-download file from Firebase Console if corrupted

---

## Step 6: Configure Xcode Project (If Needed)

If building on macOS with Xcode:

### 6.1 Add Push Notifications Capability

1. Open `ios/Runner.xcworkspace` in Xcode
2. Select **Runner** project
3. Go to **Signing & Capabilities** tab
4. Click **+ Capability**
5. Add **Push Notifications**
6. Add **Background Modes** → Check **Remote notifications**

### 6.2 Update App Delegate (Already Configured)

The Flutter Firebase Messaging plugin automatically configures the app delegate. Verify `ios/Runner/AppDelegate.swift` imports Firebase:

```swift
import UIKit
import Flutter
import Firebase  // Auto-added by Flutter plugin

@UIApplicationMain
@objc class AppDelegate: FlutterAppDelegate {
  override func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey: Any]?
  ) -> Bool {
    GeneratedPluginRegistrant.register(with: self)
    return super.application(application, didFinishLaunchingWithOptions: launchOptions)
  }
}
```

---

## Step 7: Test Push Notifications on iOS Device

### 7.1 Prerequisites

- iOS device connected via USB (simulator doesn't support APNs)
- Xcode configured with valid provisioning profile
- APNs key/certificate uploaded to Firebase Console

### 7.2 Install and Launch App

```bash
# Build and deploy to device
flutter run --release
```

### 7.3 Request Notification Permission

On app launch, iOS prompts for notification permission:
- Tap **Allow** to enable push notifications

### 7.4 Retrieve FCM Token

Check device logs for FCM token:
```
[Firebase/Messaging] FCM registration token: eR5tY...xZ8mN
```

### 7.5 Send Test Notification via Azure Function

```bash
# Use E2E test script
export COSMOS_CONNECTION_STRING="AccountEndpoint=https://..."
./scripts/run-e2e-notification-test.sh ios-device-user POST_LIKE

# Wait 60 seconds
# Push notification should appear on device
```

---

## iOS vs Android Differences

| Feature | Android | iOS |
|---------|---------|-----|
| Config File | `google-services.json` | `GoogleService-Info.plist` |
| Location | `android/app/` | `ios/Runner/` |
| Build Plugin | Google services Gradle plugin | Flutter auto-integration |
| Push Service | FCM (direct) | FCM → APNs (indirect) |
| Credentials | Firebase API key | APNs key/certificate required |
| Simulator Testing | ✅ Supported | ❌ Not supported (needs device) |
| Background Delivery | Immediate | Depends on APNs priority |

---

## Privacy & Compliance Notes

### FCM-Only Usage (No Analytics)

**Disabled in Info.plist**:
```xml
<key>FirebaseAnalyticsCollectionEnabled</key>
<false/>
```

**What this means**:
- ✅ FCM push notifications work normally
- ❌ Firebase Analytics SDK disabled
- ❌ Google Analytics data collection disabled
- ❌ No user behavior tracking
- ❌ No advertising ID collection

### APNs Data Handling

- FCM acts as a relay to APNs (Apple's service)
- Push payload encrypted in transit (TLS)
- Device token stored in Cosmos DB (encrypted at rest)
- See `docs/ADR_001_ADDENDUM_PUSH_NOTIFICATIONS_PRIVACY.md` for full analysis

---

## Next Steps

After completing iOS setup:

1. **Configure Azure Notification Hub**:
   ```bash
   ./scripts/setup-azure-notification-hub.sh dev rg-asora-dev eastus
   ```

2. **Set Function App Environment Variables**:
   ```bash
   ./scripts/set-function-app-env-vars.sh asora-function-dev dev
   ```

3. **Run End-to-End Test**:
   ```bash
   ./scripts/run-e2e-notification-test.sh user-123 POST_LIKE
   ```

4. **Deploy to Production**:
   - Repeat steps for `prod` environment
   - Use production APNs certificate (not sandbox)
   - Update Firebase Console for production bundle ID

---

## Troubleshooting Reference

### Common Issues

**Issue**: "No APNs token received"
- **Cause**: APNs credentials not configured in Firebase Console
- **Fix**: Upload APNs key/certificate per Step 3

**Issue**: "Remote notification background mode not configured"
- **Cause**: Missing Background Modes entitlement
- **Fix**: Xcode → Add Background Modes capability → Check "Remote notifications"

**Issue**: "Firebase configuration file not found"
- **Cause**: `GoogleService-Info.plist` not in correct location
- **Fix**: Ensure file is in `ios/Runner/` (not subdirectory)

**Issue**: "Bundle identifier mismatch"
- **Cause**: Firebase config file has different bundle ID
- **Fix**: Re-download config from Firebase Console for correct bundle ID

### Debug Commands

```bash
# Check if config file exists
ls -l ios/Runner/GoogleService-Info.plist

# Verify bundle ID in config
plutil -p ios/Runner/GoogleService-Info.plist | grep BUNDLE_ID

# Check Info.plist for Analytics disable
grep -A1 "FirebaseAnalyticsCollectionEnabled" ios/Runner/Info.plist

# View device logs (macOS only)
# Xcode → Window → Devices and Simulators → Open Console
```

---

## References

- [Firebase iOS Setup Guide](https://firebase.google.com/docs/ios/setup)
- [Firebase Cloud Messaging (FCM) iOS](https://firebase.google.com/docs/cloud-messaging/ios/client)
- [APNs Provider API](https://developer.apple.com/documentation/usernotifications)
- [Flutter Firebase Messaging Plugin](https://pub.dev/packages/firebase_messaging)
- Internal: `docs/firebase_fcm_setup.md` (Android + general setup)
- Internal: `NOTIFICATIONS_DEPLOYMENT_GUIDE.md` (full deployment workflow)

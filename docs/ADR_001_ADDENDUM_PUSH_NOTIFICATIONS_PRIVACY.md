# ADR 001 Addendum: Push Notifications Privacy

**Date**: January 2025  
**Status**: Approved  
**Related**: ADR 001, ADR 002 (Cosmos Partitioning), NOTIFICATIONS_SUBSYSTEM_COMPLETE.md

---

## Summary

Asora uses **Firebase Cloud Messaging (FCM)** and **Apple Push Notification Service (APNS)** exclusively for delivering push notifications to user devices. This addendum clarifies how push notification infrastructure aligns with Asora's privacy-by-design principles outlined in ADR 001.

---

## Firebase Usage (Limited Scope)

### What Firebase IS Used For
- **FCM Token Generation**: Obtain device-specific push tokens on Android/iOS
- **Push Message Transport**: Deliver notifications via FCM/APNS infrastructure
- **Token Refresh Handling**: Detect when tokens expire and request new ones

### What Firebase is NOT Used For
Firebase SDK is integrated, but the following features are **explicitly disabled**:
- âŒ Firebase Analytics
- âŒ Firebase Crashlytics
- âŒ Firebase Realtime Database
- âŒ Firebase Firestore
- âŒ Firebase Authentication
- âŒ Firebase Remote Config
- âŒ Firebase Performance Monitoring
- âŒ Google Analytics for Firebase
- âŒ Firebase In-App Messaging

**Justification**: Firebase is used solely as a **transport mechanism** for push notifications. All user data, preferences, and analytics remain within Asora-controlled infrastructure (Cosmos DB, Application Insights).

**Implementation**:
- Android: `AndroidManifest.xml` sets `firebase_analytics_collection_enabled=false`
- iOS: `Info.plist` sets `FirebaseAnalyticsCollectionEnabled=NO`
- Runtime: `Firebase.initializeApp()` called with minimal configuration (no analytics services)

---

## Data Processing & Storage

### Data Collected
| Data Point | Purpose | Retention | Location |
|------------|---------|-----------|----------|
| **Device Push Token** | Deliver push notifications | Until device revoked or 90 days inactive | Cosmos DB (`device_tokens` container) |
| **Device Label** | Help users identify their devices | Same as token | Cosmos DB |
| **Platform** (fcm/apns) | Route to correct push service | Same as token | Cosmos DB |
| **Last Seen Timestamp** | Enforce 3-device cap, evict inactive devices | Same as token | Cosmos DB |
| **Notification Preferences** | Respect category toggles, quiet hours | Indefinitely or until user deletion | Cosmos DB (`notification_preferences`) |

### Data NOT Collected
- âŒ Device IMEI, serial number, or hardware IDs
- âŒ User location (coordinates, IP address for geofencing)
- âŒ Notification interaction analytics (open rates, click rates)
- âŒ Cross-app tracking identifiers (IDFA, AAID)
- âŒ Device battery, memory, or performance metrics

**Note**: Device tokens are opaque identifiers generated by FCM/APNS. They do not contain personally identifiable information (PII) and cannot be reverse-engineered to identify users outside Asora's systems.

---

## User Control & Consent

### User-Facing Controls
1. **Permission Prompt**: OS-level permission request before enabling push (iOS/Android standard)
2. **Category Toggles**: Users control which notification types they receive:
   - âœ… Social Updates (likes, comments, follows) â€” Optional
   - âœ… News & Updates (app announcements) â€” Optional
   - âœ… Marketing (promotions) â€” Optional
   - ðŸ”’ Safety Alerts (content moderation) â€” **Always enabled** (critical safety)
   - ðŸ”’ Security Alerts (new device, password change) â€” **Always enabled** (fraud prevention)
3. **Quiet Hours**: 24-hour grid to block notifications during specific hours (default: 22:00-07:00 local time)
4. **Device Management**: Users can view and revoke registered devices (enforces 3-device cap)

### No Consent Required
- **Security Notifications**: Bypass quiet hours and category preferences (fraud detection, account lockouts)
- **Safety Notifications**: Bypass quiet hours (content flagged, account warnings)

**Justification**: Security and safety alerts protect users from immediate harm. GDPR Article 6(1)(f) (legitimate interests) and POPIA Section 11(1)(f) (protection of legitimate interests) allow processing for fraud prevention and safety without explicit consent.

---

## Third-Party Data Sharing

### Firebase/Google
- **Data Shared**: Device push tokens (opaque identifiers), notification payloads (title, body, deeplink)
- **Purpose**: Push notification delivery via FCM infrastructure
- **Retention**: Google retains FCM tokens until invalidated (device uninstall, token refresh)
- **Legal Basis**: Necessary for service provision (GDPR Art. 6(1)(b), POPIA Section 11(1)(a))

**Important**: Notification payloads are encrypted in transit (TLS 1.3). Google cannot decrypt end-to-end encrypted content but can see notification titles/bodies sent via FCM API.

### Apple (APNS)
- **Data Shared**: Device push tokens (opaque identifiers), notification payloads
- **Purpose**: Push notification delivery via APNS infrastructure
- **Retention**: Apple retains APNS tokens until invalidated
- **Legal Basis**: Same as FCM

### Azure Notification Hubs
- **Data Shared**: Device tokens, push payloads, platform identifiers (fcm/apns)
- **Purpose**: Orchestrate push delivery across FCM/APNS
- **Retention**: Tokens stored until explicitly deleted or device inactive for 90 days
- **Legal Basis**: Microsoft DPA (Data Processing Agreement), GDPR-compliant

**Note**: Azure Notification Hubs is a "processor" under GDPR. Microsoft cannot use Asora's push tokens for their own purposes.

---

## GDPR & POPIA Compliance

### Data Subject Rights
Users can exercise the following rights via Asora's Privacy Service (`/api/privacy/*`):

1. **Right to Access (GDPR Art. 15, POPIA Section 23)**: Export includes:
   - Device tokens (last 4 digits only)
   - Device labels and platforms
   - Notification preferences (categories, quiet hours, timezone)
   - Recent notifications (last 30 days, auto-expire)

2. **Right to Erasure (GDPR Art. 17, POPIA Section 24)**: Deletes:
   - All device tokens for user
   - All notification preferences
   - All in-app notifications
   - All pending notification events

3. **Right to Rectification (GDPR Art. 16, POPIA Section 23)**: Users can:
   - Update device labels
   - Change notification preferences
   - Adjust quiet hours and timezone

4. **Right to Restrict Processing (GDPR Art. 18)**: Users can:
   - Disable specific notification categories
   - Revoke device tokens (stops push delivery)
   - Enable global quiet hours (blocks all non-critical notifications)

**Data Retention**:
- **Notification Events**: 30-day TTL (auto-expire via Cosmos DB)
- **In-App Notifications**: 30-day TTL (auto-expire)
- **Device Tokens**: Until revoked or 90 days inactive
- **Preferences**: Retained indefinitely (until account deletion)

---

## Security & Integrity

### Push Token Security
- **Storage**: Cosmos DB with encryption at rest (Microsoft-managed keys)
- **Transmission**: TLS 1.3 between Flutter app â†” Azure Functions â†” Notification Hubs
- **Access Control**: Device tokens readable only by authenticated user (JWT validation)
- **3-Device Cap**: Oldest device auto-revoked when 4th device registers (prevents token abuse)

### Notification Content
- **No PII in Payloads**: Notification titles/bodies use generic templates:
  - âœ… "Jane Doe liked your post" (actor name, not user PII)
  - âœ… "New device signed in from San Francisco" (generic location, not precise GPS)
  - âŒ "Your credit card ending 1234 was charged" (too much PII)
- **Deep Links**: Use opaque identifiers (`asora://post/abc123`, not user IDs)
- **Rate Limiting**: Prevents notification spam (3/hour for social, 10/hour for safety)

---

## Audit & Monitoring

### Logging
All notification operations are logged to **Application Insights** with the following events:
- `NotificationEnqueued`: Event type, category, user ID (hashed)
- `NotificationProcessed`: Success/failure, error codes, retry count
- `PushSent`: Platform (fcm/apns), device count, latency
- `DeviceRegistered`: User ID (hashed), platform, device label
- `DeviceRevoked`: User ID (hashed), reason (user action, 3-device cap, inactive)

**Retention**: 90 days in Application Insights (GDPR-compliant)

### Metrics
- **Success Rate**: `(pushes_sent / pushes_attempted) >= 95%` (SLO)
- **Latency**: Event enqueued â†’ push sent â‰¤ 2 minutes (P95)
- **Failure Tracking**: Retries up to 5 times before marking event as FAILED

---

## Privacy-by-Design Principles (ADR 001 Alignment)

| Principle | Implementation |
|-----------|----------------|
| **Data Minimization** | Only collect device tokens, platform, label (no IMEI, location, analytics) |
| **Purpose Limitation** | Tokens used exclusively for push delivery, not cross-app tracking |
| **User Control** | Category toggles, quiet hours, device management, revocation |
| **Security** | Encrypted storage, TLS 1.3 transport, JWT auth, 3-device cap |
| **Transparency** | Privacy policy links, in-app explanations, export includes device data |
| **Retention Limits** | 30-day TTL on notifications, 90-day inactive device cleanup |

---

## Changes from ADR 001

### Additions
- Push notification infrastructure (Firebase FCM, Azure Notification Hubs)
- Device token management (3-device cap, revocation, last-seen tracking)
- Notification preferences (categories, quiet hours, timezone)

### No Changes
- Auth flow (Firebase Auth â†’ Azure AD B2C) unaffected
- Cosmos DB partitioning strategy (notifications use `/userId` partition key)
- Privacy Service integration (DSR export/delete includes notification data)

---

## Review & Updates

**Periodic Reviews**:
- **Quarterly**: Check Firebase SDK updates for new analytics opt-outs
- **Annual**: Re-assess third-party dependencies (FCM, APNS, Azure Notification Hubs)
- **On Demand**: If Firebase changes terms of service or privacy policies

**Approval Authority**: Compliance Owner (DPO/Privacy Officer)

---

## References

- **ADR 001**: Overall architecture and privacy-by-design principles
- **ADR 002**: Cosmos DB partitioning (notifications use `/userId` partition key)
- **NOTIFICATIONS_SUBSYSTEM_COMPLETE.md**: Implementation details
- **docs/firebase_fcm_setup.md**: Firebase configuration and Analytics disabling
- **docs/notifications_cosmos_schema.md**: Cosmos DB schema with TTL and indexes

---

**Last Updated**: January 15, 2025  
**Reviewed By**: Privacy Officer, Backend Team  
**Status**: Approved for P1 implementation

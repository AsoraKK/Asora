openapi: 3.1.0
info:
  title: Asora API (P1)
  version: 1.0.0
  description: Minimal specification for P1 endpoints exposed by the Functions app.
servers:
  - url: https://asora-function-dev.azurewebsites.net
    description: Flex Consumption (prod)
security:
  - bearerAuth: []
tags:
  - name: system
    description: System and health check endpoints
  - name: auth
    description: Authentication and user identity
  - name: feed
    description: Content feed operations
  - name: posts
    description: Post creation and management
  - name: moderation
    description: Content moderation and appeals
  - name: privacy
    description: Privacy and data management
  - name: privacy-admin
    description: Admin-only Data Subject Request and legal hold flows
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    Health:
      type: object
      properties:
        ok: { type: boolean, example: true }
        timestamp: { type: string, format: date-time }
        service: { type: string, example: asora-functions }
    UserInfo:
      type: object
      properties:
        sub: { type: string }
        email: { type: string, format: email }
        name: { type: string }
        picture: { type: string }
        profile: { type: string }
        locale: { type: string }
    FeedItem:
      type: object
      properties:
        id: { type: string }
        authorId: { type: string }
        text: { type: string }
        createdAt: { type: string, format: date-time }
        likeCount: { type: integer }
        commentCount: { type: integer }
    FeedResponse:
      type: object
      properties:
        posts:
          type: array
          items: { $ref: '#/components/schemas/FeedItem' }
        totalCount: { type: integer }
        hasMore: { type: boolean }
        page: { type: integer }
        pageSize: { type: integer }
    PostCreateRequest:
      type: object
      required: [ text ]
      properties:
        text: { type: string, maxLength: 500 }
        mediaUrls: { type: array, items: { type: string } }
    PostResponse:
      allOf:
        - $ref: '#/components/schemas/FeedItem'
    FlagRequest:
      type: object
      required: [ contentId, contentType, reason ]
      properties:
        contentId: { type: string }
        contentType: { type: string, enum: [ post, comment, user, message ] }
        reason: { type: string, enum: [ spam, harassment, hate_speech, violence, adult_content, misinformation, copyright, privacy, other ] }
        additionalDetails: { type: string }
    AppealRequest:
      type: object
      required: [ contentId, reason ]
      properties:
        contentId: { type: string }
        reason: { type: string }
        details: { type: string }
    AppealResponse:
      type: object
      properties:
        appealId: { type: string }
        status: { type: string, enum: [ pending, approved, rejected ] }
        submittedAt: { type: string, format: date-time }
    VoteRequest:
      type: object
      required: [ vote ]
      properties:
        vote: { type: string, enum: [ approve, reject ] }
    ExportResponse:
      type: object
      properties:
        metadata:
          type: object
          properties:
            exportId: { type: string }
            exportedAt: { type: string, format: date-time }
        userProfile: { type: object }
        content: { type: object }
        interactions: { type: object }
        moderation: { type: object }
        privacy: { type: object }
    DsrType:
      type: string
      enum: [ export, delete ]
    DsrStatus:
      type: string
      enum: [ queued, running, awaiting_review, ready_to_release, released, succeeded, failed, canceled ]
    DsrReviewerRecord:
      type: object
      properties:
        by: { type: string }
        at: { type: string, format: date-time }
        notes: { type: string }
        pass: { type: boolean }
    DsrReviewState:
      type: object
      properties:
        reviewerA:
          $ref: '#/components/schemas/DsrReviewerRecord'
        reviewerB:
          $ref: '#/components/schemas/DsrReviewerRecord'
        approver:
          type: object
          properties:
            by: { type: string }
            at: { type: string, format: date-time }
    AuditEntry:
      type: object
      properties:
        at: { type: string, format: date-time }
        by: { type: string }
        event: { type: string }
        meta:
          type: object
          additionalProperties: true
    DsrRequest:
      type: object
      properties:
        id: { type: string }
        type:
          $ref: '#/components/schemas/DsrType'
        userId: { type: string }
        requestedBy: { type: string }
        requestedAt: { type: string, format: date-time }
        startedAt: { type: string, format: date-time }
        completedAt: { type: string, format: date-time }
        status:
          $ref: '#/components/schemas/DsrStatus'
        attempt: { type: integer }
        exportBlobPath: { type: string }
        exportBytes:
          type: integer
          format: int64
        failureReason: { type: string }
        signedUrl: { type: string }
        review:
          $ref: '#/components/schemas/DsrReviewState'
        audit:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
    DsrRequestInput:
      type: object
      required: [ userId ]
      properties:
        userId:
          type: string
          description: UUID v7 of the subject
        note:
          type: string
          description: Optional operator note
    DsrActionResponse:
      type: object
      properties:
        id: { type: string }
        status:
          $ref: '#/components/schemas/DsrStatus'
        message: { type: string }
    DsrReleaseResponse:
      type: object
      properties:
        downloadUrl: { type: string }
        expiresAt: { type: string, format: date-time }
        status:
          $ref: '#/components/schemas/DsrStatus'
        signedUrl: { type: string }
    LegalHoldInput:
      type: object
      required: [ scope, scopeId, reason ]
      properties:
        scope:
          type: string
          enum: [ user, post, case ]
        scopeId: { type: string }
        reason: { type: string }
    LegalHoldRecord:
      type: object
      properties:
        id: { type: string }
        scope: { type: string }
        scopeId: { type: string }
        reason: { type: string }
        requestedBy: { type: string }
        startedAt: { type: string, format: date-time }
        expiresAt: { type: string, format: date-time }
        active: { type: boolean }
        audit:
          type: array
          items:
            type: object
            properties:
              at: { type: string, format: date-time }
              by: { type: string }
              event:
                type: string
                enum: [ placed, cleared ]
              note: { type: string }
    LegalHoldClear:
      type: object
      required: [ id ]
      properties:
        id: { type: string }
paths:
  /api/health:
    get:
      operationId: getHealth
      summary: Health check
      tags: [system]
      description: Returns system health status
      security: []
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/Health' }
  /api/auth/userinfo:
    get:
      operationId: getUserInfo
      summary: OIDC user info
      tags: [auth]
      description: Returns authenticated user information
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/UserInfo' }
        '401': { description: Unauthorized }
  /api/feed:
    get:
      operationId: getFeed
      summary: Get feed
      tags: [feed]
      description: Returns paginated feed content
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: query
          name: page
          schema: { type: integer, default: 1 }
        - in: query
          name: pageSize
          schema: { type: integer, default: 20 }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema: { $ref: '#/components/schemas/FeedResponse' }
  /api/posts:
    post:
      operationId: createPost
      summary: Create a post
      tags: [posts]
      description: Creates a new post with content moderation
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/PostCreateRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/PostResponse' }
        '400': { description: Bad request }
        '401': { description: Unauthorized }
  /api/posts/{postId}:
    delete:
      operationId: deletePost
      summary: Delete a post
      tags: [posts]
      description: Deletes a specific post by ID
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: postId
          required: true
          schema: { type: string }
      responses:
        '200': { description: Deleted }
        '404': { description: Not found }
  /api/moderation/flag:
    post:
      operationId: flagContent
      summary: Flag content for review
      tags: [moderation]
      description: Reports content for moderation review
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/FlagRequest' }
      responses:
        '200': { description: Accepted }
        '409': { description: Already flagged }
  /api/moderation/appeals:
    post:
      operationId: submitAppeal
      summary: Submit an appeal
      tags: [moderation]
      description: Appeals a moderation decision
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/AppealRequest' }
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema: { $ref: '#/components/schemas/AppealResponse' }
  /api/moderation/appeals/{appealId}/vote:
    post:
      operationId: voteOnAppeal
      summary: Vote on an appeal
      tags: [moderation]
      description: Casts a vote on a moderation appeal
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: appealId
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/VoteRequest' }
      responses:
        '200': { description: OK }
  /api/user/export:
    get:
      operationId: exportUser
      summary: Export user data
      tags: [privacy]
      description: Exports all user data for GDPR compliance
      security: [ { bearerAuth: [] } ]
      responses:
        '200':
          description: JSON export
          content:
            application/json:
              schema: { $ref: '#/components/schemas/ExportResponse' }
        '401': { description: Unauthorized }
  /api/user/delete:
    delete:
      operationId: deleteUser
      summary: Delete user account
      tags: [privacy]
      description: Permanently deletes user account and data
      security: [ { bearerAuth: [] } ]
      responses:
        '200': { description: Deleted }
        '401': { description: Unauthorized }

  /admin/dsr/export:
    post:
      operationId: enqueueDsrExport
      summary: Enqueue a DSR export
      tags: [privacy-admin]
      description: Creates a new export request controlled by privacy_admin role
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DsrRequestInput' }
      responses:
        '202':
          description: Export request queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrActionResponse'
  /admin/dsr/delete:
    post:
      operationId: enqueueDsrDelete
      summary: Enqueue a DSR delete
      tags: [privacy-admin]
      description: Creates a delete request that is soft-deleted and audited
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/DsrRequestInput' }
      responses:
        '202':
          description: Delete request queued
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrActionResponse'
  /admin/dsr/{id}:
    get:
      operationId: getDsrStatus
      summary: Retrieve the DSR request state
      tags: [privacy-admin]
      description: Returns the request with reviewer states and audit log
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: DSR request snapshot
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrRequest'
        '404': { description: Not found }
  /admin/dsr/{id}/retry:
    post:
      operationId: retryDsrRequest
      summary: Retry a failed DSR request
      tags: [privacy-admin]
      description: Increments attempt counter and reschedules the worker
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        description: Optional progress note
        required: false
        content:
          application/json:
            schema:
              type: object
              properties:
                note: { type: string }
      responses:
        '202':
          description: Retry accepted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrActionResponse'
        '409': { description: Cannot retry }
  /admin/dsr/{id}/cancel:
    post:
      operationId: cancelDsrRequest
      summary: Cancel a queued DSR request
      tags: [privacy-admin]
      description: Moves a running request to canceled status and logs the event
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '202':
          description: Cancellation scheduled
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrActionResponse'
        '409': { description: Cannot cancel }
  /admin/dsr/{id}/reviewA:
    post:
      operationId: reviewADsr
      summary: Reviewer A decision
      tags: [privacy-admin]
      description: Captures checklist A (private export) results
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ pass ]
              properties:
                pass: { type: boolean }
                notes: { type: string }
      responses:
        '200':
          description: Review recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
        '400': { description: Invalid input }
  /admin/dsr/{id}/reviewB:
    post:
      operationId: reviewBDsr
      summary: Reviewer B decision
      tags: [privacy-admin]
      description: Captures checklist B (operational) results
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [ pass ]
              properties:
                pass: { type: boolean }
                notes: { type: string }
      responses:
        '200':
          description: Review recorded
          content:
            application/json:
              schema:
                type: object
                properties:
                  status: { type: string }
        '400': { description: Invalid input }
  /admin/legal-hold/place:
    post:
      operationId: placeLegalHold
      summary: Place a legal hold
      tags: [privacy-admin]
      description: Records an active hold on user/post/case scope
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LegalHoldInput' }
      responses:
        '201':
          description: Legal hold recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHoldRecord'
  /admin/legal-hold/clear:
    post:
      operationId: clearLegalHold
      summary: Clear a legal hold
      tags: [privacy-admin]
      description: Marks a hold inactive and records the audit
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LegalHoldClear' }
      responses:
        '200':
          description: Hold cleared
        '404': { description: Hold not found }
  /admin/dsr/{id}/release:
    post:
      operationId: releaseDsrExport
      summary: Release signed ZIP link
      tags: [privacy-admin]
      description: Validates reviewers, generates 12h SAS, and transitions to released
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Download link returned
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrReleaseResponse'
        '409': { description: Awaiting reviewers }
  /admin/dsr/{id}/download:
    get:
      operationId: downloadDsrExport
      summary: Regenerate the signed ZIP link
      tags: [privacy-admin]
      description: Re-issues a 12h SAS for released exports
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: SAS link for the ZIP
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DsrReleaseResponse'
        '404': { description: Not found }
  /admin/dsr/legal-holds:
    post:
      operationId: placeLegalHoldLegacy
      summary: Place a legal hold
      tags: [privacy-admin]
      description: Records an active hold on user/post/case scope
      security: [ { bearerAuth: [] } ]
      requestBody:
        required: true
        content:
          application/json:
            schema: { $ref: '#/components/schemas/LegalHoldInput' }
      responses:
        '201':
          description: Legal hold recorded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/LegalHoldRecord'
  /admin/dsr/legal-holds/{id}/clear:
    post:
      operationId: clearLegalHoldLegacy
      summary: Clear a legal hold
      tags: [privacy-admin]
      description: Marks a hold inactive and records the audit
      security: [ { bearerAuth: [] } ]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Hold cleared
        '404': { description: Hold not found }

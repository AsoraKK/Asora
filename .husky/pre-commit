#!/usr/bin/env bash

echo "ðŸ” Running pre-commit formatting checks (modern Husky, shim removed)..."

# Check Dart formatting (Flutter app)
echo "ðŸ“± Checking Dart formatting..."
dart format --output=none --set-exit-if-changed .
if [ $? -ne 0 ]; then
  echo "âŒ Dart formatting check failed. Please run: dart format ."
  exit 1
fi
echo "âœ… Dart formatting check passed"

# Check Functions (JavaScript) formatting and linting with auto-fix
echo "âš¡ Checking Functions formatting and linting..."
pushd functions > /dev/null

if [ ! -d "node_modules" ]; then
  echo "ðŸ“¦ Installing Functions dependencies (first run)..."
  npm install --no-audit --no-fund
fi

echo "ðŸ›   Running Prettier auto-fix..."
npm run format >/dev/null 2>&1 || true

echo "ðŸ”Ž Verifying formatting..."
if ! npm run format:check >/dev/null 2>&1; then
  echo "âŒ Remaining format issues (unexpected)"; exit 1; fi
echo "âœ… Functions formatting OK"

echo "ðŸ§¹ Running ESLint (auto-fix)..."
npm run lint >/dev/null 2>&1 || true

echo "ðŸ”Ž Verifying lint..."
if ! npm run lint:check >/dev/null 2>&1; then
  echo "âŒ Lint issues remain"; exit 1; fi
echo "âœ… Functions lint OK"

popd > /dev/null
echo "ðŸŽ‰ All formatting checks passed! Commit proceeding..."

#!/usr/bin/env bash

echo "ğŸ” Running pre-commit formatting checks (modern Husky, shim removed)..."

# Validate OpenAPI spec and regenerate client first
echo "ğŸ“„ Validating OpenAPI spec and client..."
if ! npm run openapi:lint; then
  echo "âŒ OpenAPI lint failed"; exit 1; fi
if ! npm run openapi:bundle; then
  echo "âŒ OpenAPI bundle failed"; exit 1; fi
if ! npm run openapi:gen:dart; then
  echo "âŒ Dart client generation failed"; exit 1; fi
# Ensure regenerated client files are staged in this commit
git add -A lib/generated/api_client || true
echo "âœ… OpenAPI validation passed"

# Check Dart formatting (Flutter app) - after client regeneration
echo "ğŸ“± Checking Dart formatting..."
find . -name "*.dart" -not -path "./lib/generated/*" -not -path "./.git/*" -not -path "./.dart_tool/*" -exec dart format --output=none --set-exit-if-changed {} +
if [ $? -ne 0 ]; then
  echo "âŒ Dart formatting check failed. Please run: find . -name \"*.dart\" -not -path \"./lib/generated/*\" -not -path \"./.git/*\" -not -path \"./.dart_tool/*\" -exec dart format --output=none --set-exit-if-changed {} +"
  exit 1
fi
echo "âœ… Dart formatting check passed"

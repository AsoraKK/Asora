#!/usr/bin/env bash

echo "üîç Running pre-commit formatting checks (modern Husky, shim removed)..."

# Validate OpenAPI spec and regenerate client first
echo "üìÑ Validating OpenAPI spec and client..."
if ! npm run openapi:lint; then
  echo "‚ùå OpenAPI lint failed"; exit 1; fi
if ! npm run openapi:bundle; then
  echo "‚ùå OpenAPI bundle failed"; exit 1; fi
if ! npm run openapi:gen:dart; then
  echo "‚ùå Dart client generation failed"; exit 1; fi
# Ensure regenerated client files are staged in this commit
git add -A lib/generated/api_client || true
echo "‚úÖ OpenAPI validation passed"

# Check Dart formatting (Flutter app) - after client regeneration
echo "üì± Checking Dart formatting..."
find . -name "*.dart" -not -path "./lib/generated/*" -not -path "./.git/*" -not -path "./.dart_tool/*" -exec dart format --output=none --set-exit-if-changed {} +
if [ $? -ne 0 ]; then
  echo "‚ùå Dart formatting check failed. Please run: find . -name \"*.dart\" -not -path \"./lib/generated/*\" -not -path \"./.git/*\" -not -path \"./.dart_tool/*\" -exec dart format --output=none --set-exit-if-changed {} +"
  exit 1
fi
echo "‚úÖ Dart formatting check passed"

# Secret scan (lightweight, repo-local)
echo "üîí Scanning for plaintext secrets in code..."
# Use ripgrep with a conservative pattern set, skipping docs and generated artifacts to reduce false positives
if command -v rg >/dev/null 2>&1; then
  if rg --hidden -n --no-ignore-vcs --line-number --multiline --pcre2 "(?:AKIA|AIza|-----BEGIN PRIVATE KEY-----|GITHUB_TOKEN|client_secret|azure_client_secret|DB_PASS|PASSWORD|TOKEN|SECRET)" functions src lib tools .github --glob '!**/dist/**' --glob '!**/node_modules/**' --glob '!**/*.map' --glob '!**/*.lock' > /tmp/secret_hits.txt 2>/dev/null; then
    echo "‚ùå Potential plaintext secrets detected in code paths. Failing commit."
    echo "First 50 hits shown (full report at /tmp/secret_hits.txt):"
    head -n 50 /tmp/secret_hits.txt || true
    exit 1
  else
    echo "‚úÖ No plaintext secrets detected in code paths"
  fi
else
  echo "‚ö†Ô∏è ripgrep not installed; skipping secret scan"
fi

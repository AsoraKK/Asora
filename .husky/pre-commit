#!/usr/bin/env bash

echo "ğŸ” Running pre-commit formatting checks (modern Husky, shim removed)..."

# Check Dart formatting (Flutter app)
echo "ğŸ“± Checking Dart formatting..."
dart format --output=none --set-exit-if-changed .
if [ $? -ne 0 ]; then
  echo "âŒ Dart formatting check failed. Please run: dart format ."
  exit 1
fi
echo "âœ… Dart formatting check passed"

# Check Functions (JavaScript) formatting and linting with auto-fix
echo "âš¡ Checking Functions formatting and linting..."
cd functions

if [ ! -d "node_modules" ]; then
  echo "ğŸ“¦ Installing Functions dependencies (first run)..."
  npm install --no-audit --no-fund
fi

echo "ğŸ›   Running Prettier auto-fix..."
npm run format >/dev/null 2>&1 || true

echo "ğŸ” Verifying formatting..."
if ! npm run format:check >/dev/null 2>&1; then
  echo "âŒ Remaining format issues (unexpected)"; exit 1; fi
echo "âœ… Functions formatting OK"

echo "ğŸ§¹ Running ESLint (auto-fix)..."
npm run lint >/dev/null 2>&1 || true

echo "ğŸ” Verifying lint..."
if ! npm run lint:check >/dev/null 2>&1; then
  echo "âŒ Lint issues remain"; exit 1; fi
echo "âœ… Functions lint OK"

cd ..
echo "ğŸ“„ Validating OpenAPI spec and client..."
if ! npm run openapi:lint; then
  echo "âŒ OpenAPI lint failed"; exit 1; fi
if ! npm run openapi:bundle; then
  echo "âŒ OpenAPI bundle failed"; exit 1; fi
if ! npm run openapi:gen:dart; then
  echo "âŒ Dart client generation failed"; exit 1; fi
echo "ğŸ‰ All formatting checks passed! Commit proceeding..."
